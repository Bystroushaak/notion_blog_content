<!DOCTYPE html>
<html>
<head>
  <meta name="generator" content="HTML Tidy for HTML5 for Linux version 5.2.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>The "traits float" bug 2020/1</title>
  <link rel="stylesheet" type="text/css" href="../../style.css">
  <link rel="alternate" type="application/atom+xml" href="http://blog.rfox.eu/atom.xml">
  <link rel="shortcut icon" href="/favicon.ico">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@Bystroushaak">
  <meta name="twitter:creator" content="@Bystroushaak">
  <meta name="twitter:title" content="The &quot;traits float&quot; bug 2020/1">
  <meta name="twitter:description" content="Update from the development of my own programming language called tinySelf.">
  <meta name="twitter:image" content="http://blog.rfox.eu/en/tinySelf/The_traits_float_bug_2020-1/tinySelf_debugging_thumb.jpg">
  <script src="../../scripts.js">
  </script>
  <meta name="description" content="Update from the development of my own programming language called tinySelf.">
  <meta name="keywords" content="tinyself,selflang,diy_programming_language,debugging,rpython,python,pypy"><!-- Global site tag (gtag.js) - Google Analytics -->

  <script src="https://www.googletagmanager.com/gtag/js?id=UA-142545439-1">
  </script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-142545439-1');
  </script>
  <script data-ad-client="ca-pub-8322439660353685" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async>
  </script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
</head>
<body onload="on_body_load();">
  <div id="sidebar_top">
    <div id="last_five_top">
      <h3>New posts:</h3>
      <ul>
        <li>
          <a href="../Weekly_updates/Lifelog_2020-06-15_Todo_in_motion.html" title="Lifelog 2020-06-15; Todo in motion">Lifelog 2020-06-15; Todo in motion</a>
        </li>
        <li>
          <a href="../My_Greenspuns_counter.html" title="My Greenspun's counter">My Greenspun's counter</a>
        </li>
        <li>
          <a href="../About_this_blog/What_do_I_mean_by_node.html" title="What do I mean by node?">What do I mean by node?</a>
        </li>
        <li>
          <a href="../Explorations/Trying_Ansible_alternatives_in_python.html" title="Trying Ansible alternatives in python">Trying Ansible alternatives in python</a>
        </li>
        <li>
          <a href="../Improvements/The_Most_Personal_Device_experiment/Pebble_smartwatches.html" title="Pebble smartwatches">Pebble smartwatches</a>
        </li>
        <li>
          <a href="../Improvements/The_Most_Personal_Device_experiment.html" title="The Most Personal Device experiment"><span class="icon">ðŸ“‚</span>The Most Personal Device experiment</a>
        </li>
        <li>
          <a href="../About_this_blog/Unicode_font_subset.html" title="Unicode font subset">Unicode font subset</a>
        </li>
        <li>
          <a href="../Weekly_updates/Lifelog_2020-05-25_Work_in_progress_everywhere.html" title="Lifelog 2020-05-25; Work in progress everywhere">Lifelog 2020-05-25; Work in progress everywhere</a>
        </li>
        <li>
          <a href="http://blog.rfox.eu/en/Improvements/Vitamins_nootropics_and_other_boosters.html">Vitamins, nootropics and other boosters</a>
        </li>
        <li>
          <a href="http://blog.rfox.eu/en/objWiki/Transaction_support_for_simple_in_memory_database.html">Transaction support for simple in-memory database</a>
        </li>
      </ul>& <a href="../../Changelog.html" title="Changelog">more</a>
    </div><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8322439660353685" data-ad-slot="8589969791" data-ad-format="auto" data-full-width-responsive="true"></ins> 
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
    <div id="links_from_other_pages">
      <h3>Links to this page:</h3>
      <ul>
        <li>
          <a href="../Weekly_updates/Biweekly_update_2020-01-19_Productive_but_unsatisfactory_two_weeks.html" title="Biweekly update 2020-01-19; Productive, but unsatisfactory two weeks">Biweekly update 2020-01-19; Productive, but unsatisfactory two weeks</a>
        </li>
      </ul>
    </div>
  </div><a class="breadcrumb" href="../../index.html" title="Bystroushaak's blog">Bystroushaak's blog</a> / <a class="breadcrumb" href="../index.html" title="English section">English section</a> / <a class="breadcrumb" href="index.html" title="tinySelf">tinySelf</a> / The "traits float" bug 2020/1
  <article id="baee4985-ca94-4afc-9241-0fa00939e7de" class="page sans">
    <header>
      <h1 class="page-title">The "traits float" bug 2020/1</h1>
    </header>
    <div class="page-body">
      <p id="3c9a6d8f-c9f2-4849-8ea6-fa0e9249611e" class=""><time>@2020/01/19</time></p>
      <p id="9e990555-5039-4ef7-97cb-b1e6d17bc168" class="">Here is update from the development of tinySelf, my pet programming language inspired by Smalltalk and <a href="http://www.selflanguage.org/">Self</a>.</p>
      <p id="236c6a79-ca9b-4a5c-8bca-1edb33bd2e67" class="">When I was adding new methods to primitive types, I've encountered a nasty bug. The bug was caused by sharing primitive method objects for all instances of <code>float</code> (and <code>int</code>, <code>bool</code> and other primitive data types). By default, when <code>float</code> object is created, it has a bunch of primitive slots that are pre-filled with <em>primitive code objects</em>. This is quite costly, both in terms of memory and time.</p>
      <figure id="965c819f-428d-4ce1-b2b2-e37c805ec2ad" class="image">
        <a href="The_traits_float_bug_2020-1/floats_explanation.png" title="floats_explanation.png"><img style="width:528px" src="The_traits_float_bug_2020-1/floats_explanation.png"></a>
      </figure>
      <p id="e51abe22-3f2d-4105-99a6-1523f976d15e" class="">If you had multiple instances, whole structure would look like this:</p>
      <figure id="1bc32327-3b99-446c-aa2a-87a545f19466" class="image">
        <a href="The_traits_float_bug_2020-1/default_floats.png" title="default_floats.png"><img style="width:288px" src="The_traits_float_bug_2020-1/default_floats.png"></a>
      </figure><ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-8322439660353685" data-ad-slot="8927869381"></ins> 
      <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      <p id="38c46047-c424-40b3-9c58-e01371d16e6c" class="">Naturally, I've tried to add caching mechanism, that already works with other primitive objects, like <code>true</code>, <code>false</code> and <code>nil</code>:</p>
      <p id="1de51009-9014-42b7-b123-a66d9e238928" class=""></p>
      <figure id="550b8ea7-2a0f-4e0c-8587-6d1910b829a7" class="image">
        <a href="The_traits_float_bug_2020-1/shared_primitive_method_objects.png" title="shared_primitive_method_objects.png"><img style="width:240px" src="The_traits_float_bug_2020-1/shared_primitive_method_objects.png"></a>
      </figure>
      <p id="7fded033-ba2d-48a6-9383-f0b2a5362a4f" class="">To my surprise, what happened is that when used for the first time, it worked as expected. But when you used the primitive method in another float object, the <code>self</code> for primitive methods got redirected to the object used before. Interpreter uses this branch for handling primitive code:</p>
      <pre id="a8ea5591-114e-4059-b71c-f828d2671c8d" class="code"><code>elif slot.has_primitive_code:
    # primitives need "self" to be actually the object they are expecting,
    # for example for dicts it have to be dict, not some descendant
    # in the parent chain
    if not slot_found_directly_in_obj:
        obj = slot.scope_parent

    return_value = slot.primitive_code(
        self,
        obj,
        parameters
    )

    if return_value is not None and self.process is not None:
        self.process.frame.push(return_value)</code></pre>
      <p id="4829747e-bda7-41c0-8c48-23e652b5c3e2" class=""><code>.primitive_code()</code> method is a primitive (in rpython implemented) function expecting three parameters: <code>interpreter</code>, <code>self</code> and <code>parameters</code>.</p>
      <p id="56df5432-c4b6-4cf1-a018-798b1039deec" class="">The second parameter <code>obj</code> which is mapped to <code>self</code> in the primitive function was in this case wrong, because it was resolved from <code>traits float</code>. <code>slot_found_directly_in_obj</code> was <code>False</code>, and <code>slot</code> had <code>.scope_parent</code> property set to last object in which context it was used. This happened to be primitive from previous call.</p>
      <p id="97c61eca-cc62-4faf-a633-ce75c6759963" class="">Fixing this was easy, but figuring where to find correct object which should be used as <code>self</code> parameter for the primitive was hard. I've thought (and tried) about storing last primitive in call frame. I've explored a path to store <code>(obj, primitive)</code> pairs on the stack, or creating linked primitive stacks in each frame, and several other ways. At the end, I've solved this by looking into the <code>.scope_parent</code> of the <code>obj</code> (which is at that time currently executed method). As the parameters are mapped into the <code>.scope_parent</code> properties, this can be used as history. Code now looks like this:</p>
      <pre id="8f06bdbf-a5c2-4a82-94de-de22da8f8677" class="code"><code>elif slot.has_primitive_code:
    # primitives need "self" to be actually the object they are expecting,
    # for example for dicts it have to be dict, not some descendant
    # in the parent chain
    primitive_self = obj
    if not slot_found_directly_in_obj:
        primitive_self = self._find_primitives_self(primitive_self, slot)

    return_value = slot.primitive_code(
        self,            # mapped to `interpreter`
        primitive_self,  # mapped to `self`
        parameters       # mapped to `params`
    )

    if return_value is not None and self.process is not None:
        self.process.frame.push(return_value)</code></pre>
      <p id="adc52944-4adc-47c9-8cd7-ec7cc02acb10" class="">...</p>
      <pre id="fec5d9c0-c46a-4ee9-90ca-9fcdf84f6df0" class="code"><code>def _find_primitives_self(self, primitive_self, slot):
    """
    In case of primitives that were resolved from traits, it is more
    complicated to find `self` parameter for the primitive function.

    See tinySelf.vm.primitives.add_primitive_fn.add_primitive_fn() and
    #132 for details.

    Args:
        primitive_self (Object): Candidate for the primitive's self.
        slot (Object): Method slot with primitive code.

    Returns:
        Object: Correct primitive self.
    """
    # for slots resolved from the primitive classes (list, float, ..)
    if not isinstance(slot, PrimitiveCodeMethodObject):
        return slot.scope_parent

    # for slots resolved from traits go up the parent scope chain until you
    # find instance of the class from which this was resolved
    while not isinstance(primitive_self, slot.scope_parent.__class__):
        primitive_self = primitive_self.scope_parent
        if primitive_self is None or primitive_self is self.universe:
            return None

    return primitive_self</code></pre>
      <p id="4bc15ab8-03e7-491a-af48-fc283de4aa26" class="">It's not the cleanest solution, but it is simple and it works.</p>
      <h2 id="89626af1-0211-4864-9510-fb0cc8dc1b45" class="">On the difficulty</h2>
      <p id="2e00aac1-c7a3-4c49-aab5-52e94889d8dd" class="">Although that written like this it may look simple, this wasn't easy debugging at all. It took a lot of tracing and prints and breakpoints and logging breakpoints and mental modeling to figure what is happening.</p>
      <p id="acfc735b-f00b-4113-a7b8-c99a53c64620" class="">I've had really hard time when I tried to hold all the variables, different places, stack frames, contexts, objects and their copies and instances in my head. In the end, I was saved by outsourcing to the paper and resorting to visual memory. This sketch really helped me a lot:</p>
      <figure id="c129763b-4073-4040-b8be-9973a5acb2fe" class="image">
        <a href="The_traits_float_bug_2020-1/tinySelf_debugging.jpg" title="tinySelf_debugging.jpg"><img style="width:1600px" src="The_traits_float_bug_2020-1/tinySelf_debugging_thumb.jpg"></a>
      </figure>
      <p id="0cbe7cab-f347-4bd8-b477-e67b88010c5a" class="">What do you use for debugging? Do you have any killer technique?</p>
    </div>
  </article>
  <hr>
  <div>
    <h3>Tags</h3>
    <p><a href="../../Tags/debugging.html" title="debugging">debugging</a>, <a href="../../Tags/diy_programming_language.html" title="diy_programming_language">diy_programming_language</a>, <a href="../../Tags/pypy.html" title="pypy">pypy</a>, <a href="../../Tags/python.html" title="python">python</a>, <a href="../../Tags/rpython.html" title="rpython">rpython</a>, <a href="../../Tags/selflang.html" title="selflang">selflang</a>, <a href="../../Tags/tinyself.html" title="tinyself">tinyself</a></p>
  </div>
  <div class="corner-ribbon top-right red">
    <a href="https://www.patreon.com/bePatron?u=2618881">Become a Patron</a>
  </div><a class="twitter-share-button" id="twitter_button" href="#"><img src="../../tweet_button.svg"></a>
  <div id="sidebar_bottom">
    <div id="last_five_bottom">
      <h3>New posts:</h3>
      <ul>
        <li>
          <a href="../Weekly_updates/Lifelog_2020-06-15_Todo_in_motion.html" title="Lifelog 2020-06-15; Todo in motion">Lifelog 2020-06-15; Todo in motion</a>
        </li>
        <li>
          <a href="../My_Greenspuns_counter.html" title="My Greenspun's counter">My Greenspun's counter</a>
        </li>
        <li>
          <a href="../About_this_blog/What_do_I_mean_by_node.html" title="What do I mean by node?">What do I mean by node?</a>
        </li>
        <li>
          <a href="../Explorations/Trying_Ansible_alternatives_in_python.html" title="Trying Ansible alternatives in python">Trying Ansible alternatives in python</a>
        </li>
        <li>
          <a href="../Improvements/The_Most_Personal_Device_experiment/Pebble_smartwatches.html" title="Pebble smartwatches">Pebble smartwatches</a>
        </li>
        <li>
          <a href="../Improvements/The_Most_Personal_Device_experiment.html" title="The Most Personal Device experiment"><span class="icon">ðŸ“‚</span>The Most Personal Device experiment</a>
        </li>
        <li>
          <a href="../About_this_blog/Unicode_font_subset.html" title="Unicode font subset">Unicode font subset</a>
        </li>
        <li>
          <a href="../Weekly_updates/Lifelog_2020-05-25_Work_in_progress_everywhere.html" title="Lifelog 2020-05-25; Work in progress everywhere">Lifelog 2020-05-25; Work in progress everywhere</a>
        </li>
        <li>
          <a href="http://blog.rfox.eu/en/Improvements/Vitamins_nootropics_and_other_boosters.html">Vitamins, nootropics and other boosters</a>
        </li>
        <li>
          <a href="http://blog.rfox.eu/en/objWiki/Transaction_support_for_simple_in_memory_database.html">Transaction support for simple in-memory database</a>
        </li>
      </ul>& <a href="../../Changelog.html" title="Changelog">more</a>
    </div>
    <div id="links_from_other_pages">
      <h3>Links to this page:</h3>
      <ul>
        <li>
          <a href="../Weekly_updates/Biweekly_update_2020-01-19_Productive_but_unsatisfactory_two_weeks.html" title="Biweekly update 2020-01-19; Productive, but unsatisfactory two weeks">Biweekly update 2020-01-19; Productive, but unsatisfactory two weeks</a>
        </li>
      </ul>
    </div>
  </div><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8322439660353685" data-ad-slot="4657737295" data-ad-format="auto" data-full-width-responsive="true"></ins> 
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script> 
  <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false">
  </script> 
  <script>
  window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#edeff5",
      "text": "#838391"
    },
    "button": {
      "background": "#4b81e8"
    }
  }
  });
  </script>
</body>
</html>
