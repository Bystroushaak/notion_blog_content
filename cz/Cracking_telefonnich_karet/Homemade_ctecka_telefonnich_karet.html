<!DOCTYPE html>
<html>
<head>
  <meta name="generator" content="HTML Tidy for HTML5 for Linux version 5.2.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Homemade čtečka telefonních karet</title>
  <link rel="stylesheet" type="text/css" href="../../style.css">
  <link rel="alternate" type="application/atom+xml" href="http://blog.rfox.eu/atom_cz.xml">
  <link rel="shortcut icon" href="/favicon.ico">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@Bystroushaak">
  <meta name="twitter:creator" content="@Bystroushaak">
  <meta name="twitter:title" content="Homemade čtečka telefonních karet">
  <meta name="twitter:description" content="Článek o konstrukci čtečky telefonních karet + program který umí přečíst základní metadata.">
  <meta name="twitter:image" content="http://blog.rfox.eu/cz/Cracking_telefonnich_karet/Homemade_ctecka_telefonnich_karet/DSCF0321.jpg">
  <script src="../../scripts.js">
  </script>
  <meta name="description" content="Článek o konstrukci čtečky telefonních karet + program který umí přečíst základní metadata."><!-- Global site tag (gtag.js) - Google Analytics -->

  <script src="https://www.googletagmanager.com/gtag/js?id=UA-142545439-1">
  </script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-142545439-1');
  </script>
  <script data-ad-client="ca-pub-8322439660353685" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async>
  </script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
</head>
<body onload="on_body_load();">
  <div id="sidebar_top">
    <div id="last_five_top">
      <h3>New posts:</h3>
      <ul>
        <li>
          <a href="https://blog.rfox.eu/atom_cz.xml">Vytvořen nový Atom (RSS) feed pro českou sekci</a>
        </li>
      </ul>
    </div><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8322439660353685" data-ad-slot="8589969791" data-ad-format="auto" data-full-width-responsive="true"></ins> 
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
    <div id="links_from_other_pages">
      <h3>Links to this page:</h3>
      <ul>
        <li>
          <a href="Odkrytovani_cipu_telefonni_karty.html" title="Odkrytování čipu telefonní karty">Odkrytování čipu telefonní karty</a>
        </li>
      </ul>
    </div>
  </div><a class="breadcrumb" href="../../index.html" title="Bystroushaak's blog">Bystroushaak's blog</a> / <a class="breadcrumb" href="../index.html" title="Czech section">Czech section</a> / <a class="breadcrumb" href="index.html" title="Cracking telefonních karet">Cracking telefonních karet</a> / Homemade čtečka telefonních karet
  <article id="20da01e9-7df7-4434-9da1-9709fbd0002b" class="page sans">
    <header>
      <h1 class="page-title">Homemade čtečka telefonních karet</h1>
    </header>
    <div class="page-body">
      <p id="6034cb07-dbfd-4884-ac0d-b1b6efba470b" class=""><time>@2009/06/15</time>, thx to Joenash & (#freedom99, irc.c0renet.sk:6667)</p>
      <h2 id="8ef52a05-fd15-40dc-8d58-eb2249a6d9c9" class="">Deklarace</h2>
      <p id="71d7c8d1-d147-48c5-955c-55a1dd53bcb4" class="">Tento text pojednává o konstrukci čtečky karet pro telefonní automaty (ISO 7816-2) z běžně dostupných materiálů. Čtečku si samozřejmě můžete koupit hotovou, ale podle mě to za ty peníze nestojí.</p>
      <p id="21fb2093-5fbf-43a4-8aaf-66e0534cb7f4" class="">V textu není řešen protokol kterým karta komunikuje - to už popsali jiní a lépe než bych to zvládl já. Pokud Vás protol zajmá, na konci dokumentu jsou odkazy na články, které se problematice věnují.</p>
      <p id="44a85c63-5320-4ca6-9220-7cc28017fef6" class="">Tento text nepojednává o zápisu na kartu, protože mi to přišlo zbytečné (z části paměti kde jsou uchovány informace o kreditu Vám karta povolí jen odečítat a těch pár bitů co můžete v ostatních sekcích paměti změnit na 0 nestojí za námahu).</p>
      <div id="832e71bb-757f-484d-a286-98c96f816330" class="column-list">
        <div id="791d4247-c0b2-45c4-ae86-86ed9626aed0" style="width:50%" class="column">
          <figure id="2773e9b8-d575-4d8c-893f-b695ce397f65" class="image">
            <a href="Homemade_ctecka_telefonnich_karet/DSCF0309.jpg" title="DSCF0309.jpg"><img style="width:800px" src="Homemade_ctecka_telefonnich_karet/DSCF0309.jpg"></a>
          </figure>
          <figure id="401e3bce-890f-4e6f-807b-4511607d83f4" class="image">
            <a href="Homemade_ctecka_telefonnich_karet/DSCF0314.jpg" title="DSCF0314.jpg"><img style="width:800px" src="Homemade_ctecka_telefonnich_karet/DSCF0314.jpg"></a>
          </figure>
        </div>
        <div id="84183cfe-c3a6-4122-868e-fb1dbaf22faa" style="width:50%" class="column">
          <figure id="fda41469-f8d1-44ca-8635-cc70b3f1f3b9" class="image">
            <a href="Homemade_ctecka_telefonnich_karet/DSCF0312.jpg" title="DSCF0312.jpg"><img style="width:800px" src="Homemade_ctecka_telefonnich_karet/DSCF0312.jpg"></a>
          </figure>
          <figure id="31f467ca-c571-411a-bc49-9967f89e77f3" class="image">
            <a href="Homemade_ctecka_telefonnich_karet/DSCF0321.jpg" title="DSCF0321.jpg"><img style="width:800px" src="Homemade_ctecka_telefonnich_karet/DSCF0321.jpg"></a>
          </figure>
        </div>
      </div>
      <figure id="02287cb3-4275-4054-9901-0af5d95f9ffc" class="image">
        <a href="Homemade_ctecka_telefonnich_karet/DSCF0323.jpg" title="DSCF0323.jpg"><img style="width:800px" src="Homemade_ctecka_telefonnich_karet/DSCF0323.jpg"></a>
      </figure>
      <div id="32fda41f-137c-4aff-b237-95fe2554b97c" class="column-list">
        <div id="0805f413-7cb3-4bb3-953a-47685ee21ae8" style="width:50%" class="column">
          <figure id="1644e1f8-2ff2-4f51-8a41-60d61bae0aad" class="image">
            <a href="Homemade_ctecka_telefonnich_karet/DSCF0327.jpg" title="DSCF0327.jpg"><img style="width:800px" src="Homemade_ctecka_telefonnich_karet/DSCF0327.jpg"></a>
          </figure>
        </div>
        <div id="735b3dc5-c629-49c9-9510-fba902d717cf" style="width:50%" class="column">
          <figure id="307e4bd4-59da-44d0-832a-326117a8b6a1" class="image">
            <a href="Homemade_ctecka_telefonnich_karet/DSCF0330.jpg" title="DSCF0330.jpg"><img style="width:1024px" src="Homemade_ctecka_telefonnich_karet/DSCF0330_thumb.jpg"></a>
          </figure>
        </div>
      </div>
      <h2 id="e970356c-88b2-4bd3-9581-c78d4ffe6b6f" class="">Potřeby</h2>
      <ul id="0e020d90-cab7-4b09-9b93-b0d225ae067a" class="bulleted-list">
        <li>Nářadí
          <ul id="27b0ba3a-9571-4a4c-b596-f01cfa3ae879" class="bulleted-list">
            <li>Trafopájka</li>
          </ul>
          <ul id="01cef783-9f2b-4e02-ad97-62c6e38a8294" class="bulleted-list">
            <li>Tavná pistole</li>
          </ul>
          <ul id="a0e3c453-96e1-4cb6-a4f6-9dc655017f61" class="bulleted-list">
            <li>Kleště štípací</li>
          </ul>
          <ul id="884e54b1-b166-42a4-83a9-368b033d1a3b" class="bulleted-list">
            <li>Nůž (nejlépe odlamovací - je ostrý)</li>
          </ul>
          <ul id="c353192e-f013-4f31-abaf-daf4028b6389" class="bulleted-list">
            <li>Miniaturní šroubovák</li>
          </ul>
          <ul id="d87e24e9-e424-4f98-85b1-71b770df455e" class="bulleted-list">
            <li>Multimetr</li>
          </ul>
          <ul id="fef7dc54-04e2-4a92-b8e6-995d6c38e747" class="bulleted-list">
            <li>Telefonní karta</li>
          </ul>
          <ul id="de0cc94c-3154-45d8-b918-198df693343f" class="bulleted-list">
            <li>Arduino diecimilia</li>
          </ul>
        </li>
      </ul>
      <ul id="3ffb063b-35e6-43bb-940e-fc5eaedd0664" class="bulleted-list">
        <li>Suroviny
          <ul id="49226eaa-2ad6-49ea-b6bc-b9a604605ade" class="bulleted-list">
            <li>Pouzdro na kartu (často ho dávají ke kreditkám, nebo seženete v papírnictví)</li>
          </ul>
          <ul id="574f2e39-a63b-45aa-b502-9c3c499e334d" class="bulleted-list">
            <li>Rozvírací čtečka SIM ze starého mobilu (seženete i s mobilem za max 50kč ;)</li>
          </ul>
          <ul id="7c019b6d-1d7a-45dd-b095-77fc17e02db9" class="bulleted-list">
            <li>Kus síťového (UTP) kabelu</li>
          </ul>
          <ul id="c7629a95-8d27-43bf-910c-592451127486" class="bulleted-list">
            <li>3-5 KOhm rezistor (takzvaný pull-up rezistor)</li>
          </ul>
          <ul id="0ed2c036-75a9-499e-9a4c-f4986714881c" class="bulleted-list">
            <li>Cín</li>
          </ul>
          <ul id="c983f4d6-4d94-48e1-8f3a-aba2bf7d0c27" class="bulleted-list">
            <li>Kalafuna</li>
          </ul>
          <ul id="a5cecba5-1520-4626-a273-fd997ef27ba1" class="bulleted-list">
            <li>Silikonová tyčinka pro tavnou pistoli</li>
          </ul>
        </li>
      </ul>
      <h2 id="15230e89-2c9d-4407-9db4-e2f18fd32bca" class="">Výroba čtečky</h2><ins class="adsbygoogle" style="display:block; text-align:center;" data-ad-layout="in-article" data-ad-format="fluid" data-ad-client="ca-pub-8322439660353685" data-ad-slot="8927869381"></ins> 
      <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
      </script>
      <p id="6600a30c-f69b-405f-a7c0-e9274b76f2ee" class="">Nejdříve je nutné nachystat si všechny nástroje a suroviny, které jsou zapotřebí k výrobě čtečky. Je také vhodné si udělat místo na stole atp..</p>
      <h3 id="ff06fdf9-0719-4480-9e27-f470bce4eea7" class="">1) Příprava pouzdra</h3>
      <p id="dbf022f7-fceb-4db3-802c-c5e0bb9a4d9f" class="">V pouzdru na kartu musíme vyříznout díru, ke které bude později přidělána upravená čtečka SIM karet. Provedeme to tak, že vložíme kartu do pouzdra, označíme si kde se nachází kontaktní plošky čipu a po vyndání karty díru odlamovacím nožem (pokud se vám zdá tupý, odlomte z něj kus) vyřízneme. Doporučuji vyříznout díru do obou stran pouzdra - ulehčí Vám to práci s přizpůsobováním nožiček čtečky jeho přilepení.</p>
      <h3 id="8d304959-df58-4fd8-aa74-c9e02eb1622b" class="">2) Příprava čtečky SIM karet</h3>
      <p id="00698546-77dc-4c82-82cb-afeb0ba19736" class="">Dál je na řadě úprava čtečky SIM karet; Štípačkami z ní odštípejte všechny nepotřebné kusy plastu tak, aby šla přiložit nožičkami těsně k pouzdru. Tuto činnost si radši dopředu promyslete, ať se nestane že odstřihnete něco, po čem se čtečka rozpadne. S ohýbáním nožiček aby pasovaly na piny karty se prozatím nezabývejte - jelikož drží v tenkém kousku plastu, dokud čtečku nezalepíte silikonem, lehce se utrhnou.</p>
      <h3 id="61e364ec-1000-49e8-8cf0-184094628ef5" class="">3) Přidělání čtečky SIM karet k pouzdru</h3>
      <p id="8cf59cc6-7302-4907-b857-30a4e4142791" class="">Jakmile budete mít čtečku upravenou, je načase dát žhavit tavnou pistoli (nezapomeňte si pod ní dát kus papíru, lepidlo z ní často vytéká permanentně). Až bude pistole rozehřátá, vložte do pouzdra kartu a umístěte čtečku tak, aby se její pacičky dotýkaly plošek na kartě. Následně čtečku po stranách opatrně zafixujte a vyčkejte, dokud silikon (nebo co to je) neztuhne. Poté opatrně zohýbejte výstupní dráty co z ní vedou (nikoliv kontaktní pacičky!) vždy jeden dolu a jeden nahoru.</p>
      <h3 id="a4ec3a77-0e68-4824-82ce-047639788e2d" class="">4) Příprava UTP kabelu</h3>
      <p id="6c3a3724-4f44-4e0a-9f09-61c9e061bedd" class="">Nyní je vhodné připravit si kabel. Já jsem zvolil klasický UTP kabel, který by nemělo být problém sehnat (v prodejně počítačů, v elektro prodejně atp..). Je dobré si jednu stranu kabelu zafixovat (např. peanem, nebo na ní udělat uzel), aby se vodiče uvnitř nepohybovaly.</p>
      <p id="3d0a8356-6b0e-4831-b204-a103a5460d32" class="">Na volné (nezafixované) straně odstraňte krytí a následně i bužírku ze třech párů vodičů. Jeden zbývající pár (např. hnědý) odstřihněte, protože není zapotřebí a v konečném důsledku by jen překážel. Je vhodné si všechny odizolované konce sestřihnout na stejnou velikost (já jsem nechal asi 3mm) a drátky pocínovat - to Vám velmi usnadní práci během připajování drátů ke čtečce.</p>
      <h3 id="1f6e3306-fb01-4396-b882-bc18977279a5" class="">5) Připájení pull-up rezistoru a kabelu ke čtečce</h3>
      <p id="3c9ae760-992c-4f05-8365-1347e9f8e942" class="">Pokud máte konce drátků pocínované, tak je čas na pájení. Jestliže jste dosud nikdy nic nepájeli, doporučuji Vám najít si nějaký návod na netu a zkoušet to podle něj tak dlouho, dokud se to nenaučíte opravdu dobře. Jakmile budete mít jistotu že pájení není problém, lokalizujte pomocí multimetru výstup z UCC a I/O plošky (viz diagram u části 9) a přidělejte mezi ně (samozřejmě na výstup - tam co budete pájet dráty) pull-up rezistor (bez něj čtečka nebude fungovat) a poté připájejte ke každému výstupu jednotlivé dráty UTP kabelu.</p>
      <h3 id="422b8b3e-2066-412b-b2b7-7f9645fcb066" class="">6) Izolace připájených drátů</h3>
      <p id="77cc0c5a-653f-410a-80bc-eebdb2c7b7fd" class="">Jakmile všechny dráty připájíte, tak je nutné zalepit spoje (a celkově celou vnější část čtečky kromě děr nad pacičkami) silikonem. Dávejte si přitom dobrý pozor aby se Vám kabely nedotýkaly odizolovanými částmi!</p>
      <p id="1d659590-b789-4a76-8159-973571c3b48a" class="">Je dobré si lepení rozložit na několik kroků a vždy počkat až předchozí strana zaschne.</p>
      <h3 id="906f3ffb-a0c3-4f7e-a4c1-bf808c21f49e" class="">7) Kontrola zkratu</h3>
      <p id="80bc0b0d-481e-4264-9e65-6497299d23e9" class="">Teď, když máte hlavní konstrukci hotovou, je nutné odizolovat UTP kabel i z druhé strany a proměřit (samozřejmě s vyndanou kartou) jestli někde mezi spoji nemáte zkrat.</p>
      <p id="e63aee09-7391-41a9-b0a3-8bb70a1eef0e" class="">Pokud jste pečlivě dodržovali návod, žádný tam nebude. Když by se přeci jen stalo že měřák ukáže zkrat (nulový odpor - nikoli odpor pull-up rezistoru!), je nutné nahřát šroubovák a zkratované vodiče zalepené silikonem od sebe oddělit.</p>
      <h3 id="edf8724c-a877-4b1b-9885-d5034336e7f7" class="">8) Ohýbání nožiček čtečky</h3>
      <p id="da133024-c97d-4b71-a11f-58676508550a" class="">Jestliže máte vše úspěšně proměřené, je načase opatrně (!) zohýbat pacičky čtečky tak, aby dosahovali na kartu. Díky tomu že jste pouzdro (doufám) prořízli i z druhé strany, je to poměrně snadná záležitost. Dávejte si pozor na počet ohnutí - pacičky nevydrží moc pohybů a pokud s nimi budete kroutit déle než je nezbytně nutné, tak prostě upadnou.</p>
      <p id="afe63ae7-8131-46a1-b967-6a8232420bd3" class="">!!! Dbejte na zachování obloukového tvaru paciček, jinak se po vložení/vysunutí karty utrhnou/ohnou (vím o čem mluvím, jednu čtečku jsem takhle zničil) !!!</p>
      <h3 id="39f43262-c165-44d4-aaa4-814e12d313b1" class="">9) Mapování kabelů</h3>
      <p id="015f7210-99d2-4e76-923e-46a2d6fffbba" class="">Vložte do čtečky kartu a zjistěte kam jste který drát připájeli. Měření provádějte tak, že z vrchní strany čtečky (dírou nad pacičkama) prostrčíte hrot měřáku, přiložíte ho na plošku karty (nikoliv na pacičku čtečky - takto zjistíte jestli má pacička správný dotek ke kartě) a pak hledáte který drát k ní pasuje.</p>
      <p id="5865c520-3b7b-491f-898c-30dc6ef29844" class="">Výsledky je dobré si někam zapsat - například takto:</p>
      <h3 id="038c499d-21e5-479d-8f03-eba4d5985d60" class="">Číslování pinů karty:</h3>
      <pre id="e14839f1-7d4e-4c4f-aaf1-8f169332050f" class="code"><code>   ________________________
  |          |             | 
  | 1 UCC    |      4 GND  | 
  |_______   |  ___________|
  |       \ /   \          |                                     
  | 2 RST  |     |  5 VPP  | 
  |_______/ \   /._________| 
  |          | |           |
  | 3 CLK    | |    6 I/O  |
  `----------^-^-----------'</code></pre>
      <h3 id="e91ddafe-7cb9-4237-a365-bfb7c85b5e45" class="">Zapojení drátů k mojí čtečce:</h3>
      <ol id="e55a74ca-27d7-4c20-8061-6e40958d23b4" class="numbered-list" start="1">
        <li>UCC == Oranžovo-bílá</li>
      </ol>
      <ol id="ab6ef491-0c0c-4926-a610-0147ed34343a" class="numbered-list" start="2">
        <li>RST == Zelená</li>
      </ol>
      <ol id="3841713e-47cd-4b9a-9ba1-c4662e3c50d8" class="numbered-list" start="3">
        <li>CLK == Zeleno-bílá</li>
      </ol>
      <ol id="e1125cbd-03f7-4b5c-826a-8dc14c044f00" class="numbered-list" start="4">
        <li>GND == Modrá</li>
      </ol>
      <ol id="9cf81e80-7109-4970-96a8-cff2bc61faff" class="numbered-list" start="5">
        <li>VPP == Modro-bílá (tento kontakt je běžně nevyužit)</li>
      </ol>
      <ol id="5543e6ec-eebf-4aab-ab98-a9c7132419a7" class="numbered-list" start="6">
        <li>I/O == Oranžová</li>
      </ol>
      <p id="5e548f54-91ed-4a68-8581-beb34c85385f" class="">Pokud jste k dané plošce nenašli odpovídající kabel, je nutné více ohnout pacičku čtečky - samozřejmě s vysunutou kartou. Jakmile budete mít zjištěno kam patří který drát, je možné stavbu prohlásit za hotovou.</p>
      <h2 id="beab7cee-db11-4f77-8066-959092230470" class="">Čtení</h2>
      <p id="185f00e5-b7ef-44d8-aad5-6a519568060c" class="">Ke čtení jsem napsal program pro Arduino diecimilia, který umí přečíst paměť telefonní kartu a zobrazit o ní pár drobností (sériové číslo, počet jednotek na kartě). Pokud by měl někdo zájem vytvořit vlastní, v odkazech na konci článku jsou linky na články popisující protokol.</p>
      <p id="a029e890-fc41-4727-b3af-3552cb92dcd1" class="">Připojte čtečku k arduinu. RST na dig. port 10, CLK na 11 a I/O na 12. K portu 13 můžete připojit tlačítko, které spustí načítání ze čtečky do interní EEPROM paměti arduina - to se hodí napřiklad když nemáte po ruce PC, ale pouze arduino a čtečku.</p>
      <p id="a1416fba-2ec6-450c-8aef-f8f19582671a" class="">Program komunikuje (jak je u arduina zvykem) pomocí sériové komunikace. Ovládání můžete provádět pomocí software k arduinu, nebo vlastním programem či pomocí sériového terminálu připojeného na dig. pin 0 a 1.</p>
      <h3 id="2ec2a81c-523b-4aa5-b5f0-d4e20ade678c" class="">Ukázka menu</h3>
      <pre id="e96ac371-48af-4489-8ed5-287b23683e49" class="code"><code>  Prikazy:
      r - Nacist dump z ctecky
      n - Nacist dump z EEPROM
      u - Ulozit dump do EEPROM

      d - Zobrazit dump
      a - Zobrazit alternativni (zjednoduseny) dump

      i - Zobrazit info o karte</code></pre>
      <h3 id="7f7e052a-1aad-43fe-ae33-e88d00dfb784" class="">Ukázka dumpu</h3>
      <pre id="2a33595e-6f17-47df-b8c8-97e0f766d188" class="code"><code>  Byte  Index    DEC  HEX     BIN
    0  000-007:  161   A1  1010 0001 
    1  008-015:   43   2B  0010 1011 
    2  016-023:   99   63  0110 0011 
    3  024-031:    0   00  0000 0000 
    4  032-039:   70   46  0100 0110 
    5  040-047:  205   CD  1100 1101 
    6  048-055:  151   97  1001 0111 
    7  056-063:   35   23  0010 0011 
    8  064-071:    0   00  0000 0000 
    9  072-079:    0   00  0000 0000 
   10  080-087:  127   7F  0111 1111 
   11  088-095:   63   3F  0011 1111 
   12  096-103:    1   01  0000 0001 
   13  104-111:  254   FE  1111 1110 
   14  112-119:   34   22  0010 0010 
   15  120-127:   97   61  0110 0001</code></pre>
      <h3 id="bfba5cbb-e788-407e-ad59-8bef6563ebac" class="">Ukázka alternativního dumpu</h3>
      <pre id="07a95a7b-6891-4e89-8018-273750cd4af3" class="code"><code>  A1 2B 63 00 46 CD 97 23 00 00 7F 3F 01 FE 22 61 
  unsigned char dump[]= {0xA1, 0x2B, 0x63, 0x00, 0x46, 0xCD, 0x97, 0x23, 0x00, 0x00, 0x7F, 0x3F, 0x01, 0xFE, 0x22, 0x61};  // C array
  dump= [0xA1, 0x2B, 0x63, 0x00, 0x46, 0xCD, 0x97, 0x23, 0x00, 0x00, 0x7F, 0x3F, 0x01, 0xFE, 0x22, 0x61]  # python array</code></pre>
      <h3 id="35f6d9e1-2747-4c07-acc4-40c8bfcef367" class="">Ukázka informací o kartě</h3>
      <pre id="4a34b3d5-9dfa-495a-9cd8-f2ab40aea7eb" class="code"><code>  Pocet impulzu: 49 (nikoli korun!)
  Seriove cislo: 0004640151</code></pre>
      <h3 id="073d2c51-8b7e-4312-8d66-68e79f576efe" class="">Zdrojový kód</h3>
      <pre id="f23977ac-3b89-4911-8f98-96706f25cf42" class="code code-wrap"><code>/* APCReader [Arduino Phone Card Reader] v1.0.0 (09.06.09)
 * by Bystroushaak (bystrousak@kitakitsune.org) 
 *
 * Popis:
 *   Jednoduchy programek, ktery pomoci homemade ctecky precte obsah telefonni 
 *   (ISO 7816-2 - to je ta 6 pinnova, nebo 8 pinnova se dvema nezapojenyma) 
 *   karty.
 *
 * Lang:     Wiring
 * Platform: Arduino Diecimila
 * Licence:  CC by-nc-sa (http://creativecommons.org/licenses/by-nc-sa/3.0/cz/)
 *
 *******************************************************************************
 *
 * Reset a čtení:
 * -------------
 *   Address counter (ukazatel adresy) se resetuje na 0, pokud přijde CLK pulz
 * ve chvíli kdy je Reset v log. 1. {Poznamka: pokud zrovna AC ukazuje na adresu
 * z rozsahu 0 až 7, reset neproběhne}
 *
 *       __________________
 * _____|                  |_____________________________________________ Reset
 *      :                  :
 *      :        _____     :  _____       _____       _____       _____
 * _____:_______|     |____:_|     |_____|     |_____|     |_____|     |_ Clk
 *      :       :          : :     :     :     :     :     :     :     :
 * _____:_______:__________:_:_____:_____:_____:_____:_____:_____:_____:_
 * _____:___n___|_____0____:_|_____1_____|_____2_____|_____3_____|___4_:_(Address)
 *      :                  :       :           :           :           :
 * _____:                  :_______:___________:___________:___________:_
 * _____XXXXXXXXXXXXXXXXXXXX_______|___________|___________|___________|_ Data
 * Bit n                      Bit 0    Bit 1        Bit2       Bit3
 * 
 *   Address counter je inkrementován o 1 pokaždé, když na CLK přijde impulz 
 * během doby, kdy Reset zůstane v log. 0. Data na adrese jsou poslána na I/O pin
 * po každé sestupné CLK hraně. Address counter není možné dekrementovat. Pokud
 * se chceme dostat na bit který již byl přečten, musíme resetovat Address 
 * counter a inkrementovat do doby než se dostanem na požadovanou adresu. 
 *
 * (volný překlad z http://gsho.thur.de/gsho/phonecard/bin/phonecards_204.txt)
 *
 **/

#undef int          // bez tohodle se nenecha includnout stdio.h
#include &lt;stdio.h&gt;  // potrebne kvuli sprintf()
#include &lt;EEPROM.h&gt; // kvuli ukladani do EEPROM

#define RST 12
#define CLK 13
#define IO  10      // nutne pripojit prez pull-up rezistor (3-5KOhm) k VCC!
#define SNS 9       // sensor - pokud je na nej pripojeno kladne napeti, automaticky nacte dump a ulozi ho do EEPROM
#define LEN 128     // velikost pameti karty (v cechach to je 128b)

// Precte celou pamet karty. Data ulozi do pole predaneho v parametru.
void readCard(byte *dump){
  // reset adresniho pocitadla na 0
  digitalWrite(RST, HIGH);
  delay(1);
  digitalWrite(CLK, HIGH);
  delay(1);
  digitalWrite(CLK, LOW);
  delay(1);
  digitalWrite(RST, LOW);
  delay(1);
  
  // cteni obsahu pameti karty
  byte dec = 0, cnt = 0;
  for(int i = 0; i &lt; LEN; i++){
    // prevod z binarnich cisel na dekadicka
    dec &lt;&lt;= 1;
    if (digitalRead(IO)){
      dec++;
    }
    // ulozeni dekadickeho cisla
    if (cnt++ == 7){
      *dump++ = dec; 
      cnt= 0;
    }
    
    // clk pulz - inkrementace Address counteru
    digitalWrite(CLK, HIGH);
    delay(1);
    digitalWrite(CLK, LOW);
    delay(1);
  }
  
  // nulovani vystupu
  digitalWrite(CLK, LOW);
  digitalWrite(RST, LOW);
}

// Vypise binarni reprezentaci promenne var
void printBin(byte var){
    char tmp = 0;
    int pocetbitu = sizeof(var) * 8;
    
    int i;
    for(i = 0; i &lt; pocetbitu; i++){
        tmp = var &gt;&gt; (pocetbitu - i - 1) & 1;
        if (tmp){
            Serial.print('1');
        }else{
            Serial.print('0');
        }
        if ((i + 1) % 4 == 0){  // vypise oddelovaci mezeru po kazdych 4 vypsanych znacich
            Serial.print(' ');
        }
    }
}

// zobrazi naformatovany dump
void printDump(byte *dump){
  char buffer[30];
  
  printClr();
  Serial.println("Byte  Index    DEC  HEX     BIN");
  
  byte i, cnt= 0, n;
  for (i = 0; i &lt; (LEN / 8); i++){
    n = *dump++;
    sprintf(buffer, " %2d  %03d-%03d:  %3d   %02X  ", i, cnt, cnt + 7, n, n);
    Serial.print(buffer);
    printBin(n);
    Serial.println();
    cnt += 8;
  }
}

// Vypise na jednom radku jako Hexa, na dalsim jako C pole
// a na poslednim jako python pole - vhodne pro pozdejsi
// zpracovani udaju
void printRaw(byte *dump){
  char buffer[2];
  byte *tmp = dump;
  
  printClr();
  
  // hexa
  int i;
  for (i = 0; i &lt; (LEN / 8); i++){
    sprintf(buffer, "%02X ", *tmp++);
    Serial.print(buffer);
  }
  
  // c pole
  Serial.println();
  tmp= dump;
  Serial.print("unsigned char dump[]= {");
  for (i = 0; i &lt; (LEN / 8); i++){
    sprintf(buffer, "0x%02X", *tmp++);
    Serial.print(buffer);
    if (i &lt; ((LEN / 8) - 1)){
      Serial.print(", ");
    }
  }
  Serial.println("};  // C array");
  
  // python pole
  tmp= dump;
  Serial.print("dump= [");
  for (i = 0; i &lt; (LEN / 8); i++){
    sprintf(buffer, "0x%02X", *tmp++);
    Serial.print(buffer);
    if (i &lt; ((LEN / 8) - 1)){
      Serial.print(", ");
    }
  }
  Serial.print("]  # python array");
}

// Vrati hodnotu bitu na pozici n promenne var
int getBit(int var, int n){
    return var & (1 &lt;&lt; n) &amp;& 1;
}

// parsovani dat z karty a jejich vypis
// uznavam ze tahle fce je trochu chuda, pokud nekoho napadne co jeste zobrazit, 
// popr. sezene popis pameti ceske (ne slovenske!) karty, muj mail mate..
void printInf(byte *dump){
  char buffer[40];
  
  printClr();
  
  // pocet jednotek - timhle si nejsem moc jistej, protoze moje karta je uz 
  // prosla, tidiz se nemuzu podivat v automatu kolik jednotek na ni opravdu je
  // pokud by zde nekdo nasel chybu, budu rad za kratky report na mail
  int i, j = 0, o = 0;
  for(i = 0; i &lt; 8; i++){
    if (getBit(dump[12], i)){
      j++;
    }
    if (getBit(dump[11], i)){
      o++;
    }
  }
  sprintf(buffer, "Pocet impulzu: %d (nikoli korun!)", o * 8 + j);
  Serial.println(buffer);
  
  // seriove cislo ceske karty
  long int snum = 0;
  snum |= dump[4];
  snum &lt;&lt;= 8;
  snum |= dump[5];
  snum &lt;&lt;= 8;
  snum |= dump[6];
  sprintf(buffer, "Seriove cislo: %010lu", snum);
  Serial.println(buffer);
}

// vypise oddelovac
void printClr(void){
  Serial.println();
  for(int i = 0; i &lt; 80; i++){
    Serial.print('-');
  }
  Serial.println();
}

void printMenu(void){
  printClr();
  Serial.println("APCReader v1.0.0 (09.06.09) by Bystroushaak (bystrousak@kitakitsune.org)");
  Serial.println();
  Serial.println("Prikazy:");
  Serial.println("    r - Nacist dump z ctecky");
  Serial.println("    n - Nacist dump z EEPROM");
  Serial.println("    u - Ulozit dump do EEPROM");
  Serial.println();
  Serial.println("    d - Zobrazit dump");
  Serial.println("    a - Zobrazit alternativni (zjednoduseny) dump");
  Serial.println();
  Serial.println("    i - Zobrazit info o karte");
  Serial.println();  
}

void dump2EEPROM(byte *dump){
  int i;
  for(i = 0; i &lt; LEN / 8; i++){
    EEPROM.write(i, dump[i]);
  }
}

// inicializace pinu a seriove konzole
void setup(){
  pinMode(RST, OUTPUT);
  pinMode(CLK, OUTPUT);
  digitalWrite(RST, LOW);   // toto nejspis neni nutne
  digitalWrite(CLK, LOW);
  
  pinMode(IO, INPUT);
  pinMode(SNS, INPUT);
  
  Serial.begin(9600);
  delay(200);               // seriova komunikace potrebuje chvili na ustanoveni
}

void loop(){
  byte dump[LEN];
  char cmd, loaded=0;
  
  printMenu();
  
  while (true){    
    if (Serial.available() &gt; 0) {
      cmd= (char) Serial.read();
        
      switch(cmd){
        case 'r':          // nacist dump ze ctecky
          readCard(dump);
          
          loaded = 1;
          Serial.println("Nacteno.");
          
          break;
        case 'u':         // ulozit dump do eeprom
          dump2EEPROM(dump);
          
          loaded = 1;
          Serial.println("Ulozeno.");
          
          break;
        case 'n':         // nacist dump z eeprom
          int i;
          for(i = 0; i &lt; LEN / 8; i++){
            dump[i] = EEPROM.read(i);
          }
          
          loaded = 1;
          Serial.println("Nacteno.");
          
          break;
        case 'd':         // vypsat dump 
          if (!loaded){
            Serial.println("ZATIM NEBYL NACTEN DUMP!");
            break;
          }
          printDump(dump);
          break;
        case 'a':         // vypsat cisty dump
          if (!loaded){
            Serial.println("ZATIM NEBYL NACTEN DUMP!");
            break;
          }
          printRaw(dump);
          break;
        case 'i':         // vypsat informace o karte 
          if (!loaded){
            Serial.println("ZATIM NEBYL NACTEN DUMP!");
            break;
          }
          printInf(dump);
          break;   
      }
      
      printMenu();
    }
    
    // pokud je alespon na 200ms pripojeno na SNS (sensor) napeti, 
    // nacte dump karty ze ctecky a ulozi ji do EEPROM
    if (digitalRead(SNS)){
      delay(200);
      if (digitalRead(SNS)){
        readCard(dump);
        dump2EEPROM(dump);
      }
    }
  }
}</code></pre>
      <h3 id="161f8978-2011-480c-8917-93592ca8a48d" class="">Nové verze</h3>
      <p id="58931269-719d-4aad-b326-195ac18fc05e" class="">Novější verze bude s trochou štěstí (uvědomuji si, že nic netrvá věčně a co se týče internetu, platí to dvojnásob..) možné sehnat na <a href="http://kitakitsune.org/">http://kitakitsune.org</a> (tedy pokud bude nějakých nových verzí potřeba..).</p>
      <h2 id="0b06196e-aeae-44d9-81b5-03813d36acba" class="">Zajímavé odkazy</h2>
      <ul id="6ba763bb-0012-44b5-b4b4-830d798adf12" class="bulleted-list">
        <li>
          <a href="http://hw.cz/Teorie-a-praxe/Navrhy-vyvojare/ART193-Ctecka-telefonnich-karet.html">Čtečka telefonních karet</a>
        </li>
      </ul>
      <ul id="d44d58f5-652d-4213-a885-463a153a6392" class="bulleted-list">
        <li>
          <a href="http://hw.cz/Teorie-a-praxe/Dokumentace/ART643-Popis-telefonne-karty-pouzivane-na-Slovensku.html">Popis telefonní karty používané naSlovensku</a>
        </li>
      </ul>
      <ul id="5dc8d5a5-d67f-44cb-9555-9578dd76f9a2" class="bulleted-list">
        <li>
          <a href="http://hw.cz/Teorie-a-praxe/Navrhy-vyvojare/ART1444-Slovenske-telefonne-karty-po-druhe.html">Slovenské telefonní karty po druhé</a>
        </li>
      </ul>
      <ul id="322fd3fb-f38b-4f53-8207-680dae6df1fb" class="bulleted-list">
        <li>
          <a href="http://gsho.thur.de/gsho/phonecard/bin/phonecards_204.txt">What you need to know about electronicstelecards</a>
        </li>
      </ul>
      <ul id="0b22a5e1-5b7f-438d-9fe7-0a124f5ba08e" class="bulleted-list">
        <li>
          <a href="http://is.muni.cz/th/139625/fi_b/">Archiv závěrečné práce - Tomáš Pyszko; Čipové karty v oblasti telekomunikací</a>
        </li>
      </ul>
      <ul id="c1b3f16a-9b76-430b-9540-b1fe0d9e66db" class="bulleted-list">
        <li>
          <a href="http://www.arduino.cz/">Stránky českého distributora Arduina</a> <a href="http://www.arduino.cc/en/Guide/HomePage">Arduino Guide</a>
        </li>
      </ul>
    </div>
  </article>
  <div class="corner-ribbon top-right red">
    <a href="https://www.patreon.com/bePatron?u=2618881">Become a Patron</a>
  </div><a class="twitter-share-button" id="twitter_button" href="#"><img src="../../tweet_button.svg"></a>
  <div id="sidebar_bottom">
    <div id="last_five_bottom">
      <h3>New posts:</h3>
      <ul>
        <li>
          <a href="https://blog.rfox.eu/atom_cz.xml">Vytvořen nový Atom (RSS) feed pro českou sekci</a>
        </li>
      </ul>
    </div>
    <div id="links_from_other_pages">
      <h3>Links to this page:</h3>
      <ul>
        <li>
          <a href="Odkrytovani_cipu_telefonni_karty.html" title="Odkrytování čipu telefonní karty">Odkrytování čipu telefonní karty</a>
        </li>
      </ul>
    </div>
  </div><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8322439660353685" data-ad-slot="4657737295" data-ad-format="auto" data-full-width-responsive="true"></ins> 
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script> 
  <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false">
  </script> 
  <script>
  window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#edeff5",
      "text": "#838391"
    },
    "button": {
      "background": "#4b81e8"
    }
  }
  });
  </script>
</body>
</html>
