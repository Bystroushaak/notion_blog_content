<!DOCTYPE html>
<html>
<head>
  <meta name="generator" content="HTML Tidy for HTML5 for Linux version 5.6.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Jak se pÃ­Å¡e programovacÃ­ jazyk 3.5: RPython</title>
  <link rel="stylesheet" type="text/css" href="../../../style.css">
  <link rel="alternate" type="application/atom+xml" href="https://blog.rfox.eu/atom_cz.xml">
  <link rel="shortcut icon" href="/favicon.ico">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@Bystroushaak">
  <meta name="twitter:creator" content="@Bystroushaak">
  <meta name="twitter:title" content="Jak se pÃ­Å¡e programovacÃ­ jazyk 3.5: RPython">
  <meta name="twitter:description" content="Parser parsuje, testy prochÃ¡zejÃ­ a svÃ­tÃ­ zelenÄ›. Co vÃ­c si pÅ™Ã¡t. Snad jen .. Ve vÅ¡emoÅ¾nÃ½ch ÄlÃ¡ncÃ­ch psali, Å¾e je dobrÃ© provÃ¡dÄ›t ÄastÃ© testy, zda jde kÃ³d pÅ™eloÅ¾it RPythonem. BÄ›hem psanÃ­ parseru to nemÄ›lo smysl, protoÅ¾e parser je obtÃ­Å¾nÄ› dÄ›litelnÃ½ kus a moje soustÅ™edÄ›nÃ­ mÃ­Å™ilo smÄ›rem k projitÃ­ unittesty. Å˜eÅ¡it u toho jeÅ¡tÄ› datovÃ© typy a vÅ¡echna omezenÃ­ RPythonu mi pÅ™iÅ¡lo jako zbyteÄnÃ½ masochismus, kterÃ½ by mohl zpÅ¯sobit, Å¾e projekt nikdy nedodÄ›lÃ¡m.">
  <meta name="twitter:image" content="https://blog.rfox.eu/cz/Programovani/Jak_se_pise_programovaci_jazyk/Jak_se_pise_programovaci_jazyk_35_RPython/passing_tests.png">
  <script src="../../../scripts.js"></script>
  <meta name="description" content="Parser parsuje, testy prochÃ¡zejÃ­ a svÃ­tÃ­ zelenÄ›. Co vÃ­c si pÅ™Ã¡t. Snad jen .. Ve vÅ¡emoÅ¾nÃ½ch ÄlÃ¡ncÃ­ch psali, Å¾e je dobrÃ© provÃ¡dÄ›t ÄastÃ© testy, zda jde kÃ³d pÅ™eloÅ¾it RPythonem. BÄ›hem psanÃ­ parseru to nemÄ›lo smysl, protoÅ¾e parser je obtÃ­Å¾nÄ› dÄ›litelnÃ½ kus a moje soustÅ™edÄ›nÃ­ mÃ­Å™ilo smÄ›rem k projitÃ­ unittesty. Å˜eÅ¡it u toho jeÅ¡tÄ› datovÃ© typy a vÅ¡echna omezenÃ­ RPythonu mi pÅ™iÅ¡lo jako zbyteÄnÃ½ masochismus, kterÃ½ by mohl zpÅ¯sobit, Å¾e projekt nikdy nedodÄ›lÃ¡m."><!-- Global site tag (gtag.js) - Google Analytics -->

  <script src="https://www.googletagmanager.com/gtag/js?id=UA-142545439-1"></script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-142545439-1');
  </script>
</head>
<body onload="on_body_load();">
  <div id="sidebar_top">
    <span><a href="https://blog.rfox.eu/atom_cz.xml"><img style="width: 3em;" src="../../../rss_icon.png"></a> &nbsp; &nbsp; <a href="https://twitter.com/Bystroushaak"><img style="width: 3em;" src="../../../twitter_icon.png"></a></span>
    <div id="last_five_top">
      <h3>New posts</h3>
      <ul>
        <li>
          <a href="../../Predstaveni/Mikrotron_pod_Vitkovem.html" title="Mikrotron pod VÃ­tkovem">Mikrotron pod VÃ­tkovem</a>
        </li>
        <li>
          <a href="../../Predstaveni/GPT-3.html" title="GPT-3">GPT-3</a>
        </li>
        <li>
          <a href="https://blog.rfox.eu/atom_cz.xml">VytvoÅ™en novÃ½ Atom (RSS) feed pro Äeskou sekci</a>
        </li>
      </ul>
    </div>
    <div id="links_from_other_pages">
      <h3>Links to this page:</h3>
      <ul>
        <li>
          <a href="Jak_se_pise_programovaci_jazyk_6_Kompilator_AST_do_bytecode.html" title="Jak se pÃ­Å¡e programovacÃ­ jazyk 6: KompilÃ¡tor AST do bytecode">Jak se pÃ­Å¡e programovacÃ­ jazyk 6: KompilÃ¡tor AST do bytecode</a>
        </li>
      </ul>
    </div>
    <div>
      <h3>Blog categories</h3>
      <ul class="no_icon">
        <li>
          <a href="../../Programovani.html" title="ProgramovÃ¡nÃ­">ğŸ“‚ ProgramovÃ¡nÃ­</a>
        </li>
        <li>
          <a href="../../Knihy.html" title="Knihy">ğŸ“‚ Knihy</a>
        </li>
        <li>
          <a href="../../Predstaveni.html" title="PÅ™edstavenÃ­">ğŸ“‚ PÅ™edstavenÃ­</a>
        </li>
        <li>
          <a href="../../Abclinuxu.html" title="Abclinuxu">ğŸ“‚ Abclinuxu</a>
        </li>
        <li>
          <a href="../../Ostatni.html" title="OstatnÃ­">ğŸ“‚ OstatnÃ­</a>
        </li>
        <li>
          <a href="../../Povidky.html" title="PovÃ­dky">ğŸ“‚ PovÃ­dky</a>
        </li>
        <li>
          <a href="../../Hrbitov.html" title="HÅ™bitov">ğŸ“‚ HÅ™bitov</a>
        </li>
        <li>
          <a href="../../index.html" title="Czech section">ğŸ“‚ Czech section</a>
        </li>
      </ul>
    </div>
  </div><a class="breadcrumb" href="../../../index.html" title="Bystroushaak's blog">Bystroushaak's blog</a> / <a class="breadcrumb" href="../../index.html" title="Czech section">Czech section</a> / <a class="breadcrumb" href="../index.html" title="ProgramovÃ¡nÃ­">ProgramovÃ¡nÃ­</a> / <a class="breadcrumb" href="index.html" title="Jak se pÃ­Å¡e programovacÃ­ jazyk">Jak se pÃ­Å¡e programovacÃ­ jazyk</a> / Jak se pÃ­Å¡e programovacÃ­ jazyk 3.5: RPython
  <article id="de209ad1-cc28-4569-bfbe-bbb8d40f277d" class="page sans">
    <header>
      <h1 class="page-title">Jak se pÃ­Å¡e programovacÃ­ jazyk 3.5: RPython</h1>
    </header>
    <div class="page-body">
      <p id="ebfbab9d-0997-4d7e-9d2a-eff3a907de26" class=""><time>@2019/02/24</time></p>
      <p id="03fb45e0-8bc8-4110-8606-ae91131be017" class="">Parser parsuje, testy prochÃ¡zejÃ­ a svÃ­tÃ­ zelenÄ›. Co vÃ­c si pÅ™Ã¡t. Snad jen .. Ve vÅ¡emoÅ¾nÃ½ch ÄlÃ¡ncÃ­ch psali, Å¾e je dobrÃ© provÃ¡dÄ›t ÄastÃ© testy, zda jde kÃ³d pÅ™eloÅ¾it RPythonem. BÄ›hem psanÃ­ parseru to nemÄ›lo smysl, protoÅ¾e parser je obtÃ­Å¾nÄ› dÄ›litelnÃ½ kus a moje soustÅ™edÄ›nÃ­ mÃ­Å™ilo smÄ›rem k projitÃ­ unittesty. Å˜eÅ¡it u toho jeÅ¡tÄ› datovÃ© typy a vÅ¡echna omezenÃ­ RPythonu mi pÅ™iÅ¡lo jako zbyteÄnÃ½ masochismus, kterÃ½ by mohl zpÅ¯sobit, Å¾e projekt nikdy nedodÄ›lÃ¡m.</p>
      <p id="e64c2589-7e2f-439f-9776-6cd5c77c28f5" class="">NormÃ¡lnÃ­ unittesty pouÅ¡tÃ­m scriptem <code>run_tests.sh</code>, kterÃ½ obsahuje nÃ¡sledujÃ­cÃ­ kÃ³d:</p>
      <pre id="40da81cb-6624-4131-a88c-9b6e62f3ea9c" class="code"><code>#! /usr/bin/env bash
export PYTHONPATH="src/:$PYTHONPATH"
python2 -m py.test tests $@</code></pre>
      <p id="7ae683d2-cbb0-4621-9f02-1d9b3b3e663c" class="">Ten je nÃ¡slednÄ› pouÅ¡tÄ›n scriptem <a href="https://github.com/joh/when-changed">when-changed</a>, jenÅ¾ detekuje zmÄ›ny na disku a pÅ™i kaÅ¾dÃ© ÃºpravÄ› zdrojovÃ½ch kÃ³dÅ¯ pustÃ­ testy:</p>
      <pre id="a94b605e-385a-4ab3-a452-bf466659be1c" class="code"><code>when-changed -s -r src/tinySelf/*.py -r tests/*.py -c ./run_tests.sh -s</code></pre>
      <p id="72928d2c-689a-440a-a5f4-e510cdd48e21" class="">Parametr <code>-s</code> zachycuje stdout z testÅ¯.</p>
      <figure id="81a6a1bb-d9c1-4dfb-8716-842f38073d43" class="image">
        <a href="Jak_se_pise_programovaci_jazyk_35_RPython/passing_tests.png" title="passing_tests.png"><img style="width:600px" src="Jak_se_pise_programovaci_jazyk_35_RPython/passing_tests.png"></a>
      </figure>
      <h2 id="f8a46fe1-393f-4df1-8a39-5f828968ec6b" class="">RPython testy</h2>
      <p id="e4902ad1-02a4-437f-897d-524b32399029" class="">RPython takto pouÅ¡tÄ›t nemÅ¯Å¾u, neboÅ¥ se nejednÃ¡ o unittesty, ale spÃ­Å¡ test kompilace trvajÃ­cÃ­ na mÃ©m domÃ¡cÃ­m poÄÃ­taÄi klidnÄ› minutu.</p>
      <p id="8ec866bf-d7d3-4396-97c3-7fa490f42da8" class="">Pro RPython jsem si do zaÄÃ¡tku napsal nÃ¡sledujÃ­cÃ­ scriptÃ­k <code>run_rpython_test.sh</code>:</p>
      <pre id="a89ab2b8-8c30-4254-bb70-aa2874844358" class="code"><code>#! /usr/bin/env bash
$HOME/Plocha/tests/pypy/rpython/bin/rpython src/tinySelf/target.py</code></pre>
      <h3 id="26f6065c-413a-45b5-b4c6-403839a5d1eb" class="">Pypy</h3>
      <p id="59551d7b-57cf-4390-817f-5d9dd6aa50bf" class="">Jak je moÅ¾nÃ© vidÄ›t, ten pÅ™edpoklÃ¡dÃ¡, Å¾e v adresÃ¡Å™i <code>$HOME/Plocha/tests</code> je naklonovanÃ½ repozitÃ¡Å™ projektu <a href="https://bitbucket.org/pypy/pypy">pypy</a>. To je moÅ¾nÃ© udÄ›lat napÅ™Ã­klad pÅ™Ã­kazem:</p>
      <pre id="e134e897-d2f5-479d-90b4-fb907109484e" class="code"><code>hg clone https://bitbucket.org/pypy/pypy</code></pre>
      <p id="f4e35067-f77d-42a5-90d1-fac743bc0b73" class="">ve sloÅ¾ce <code>$HOME/Plocha/tests</code>.</p>
      <p id="204967d1-fa29-4f85-b15c-63d8c4394917" class="">RepozitÃ¡Å™ je moÅ¾nÃ© zkompilovat a zajistit si tak nejnovÄ›jÅ¡Ã­ verzi pypy. OsobnÄ› to tak ale nedÄ›lÃ¡m, protoÅ¾e to trvÃ¡ dlouho, nejnovÄ›jÅ¡Ã­ revize repozitÃ¡Å™e typicky obsahuje bugy a navÃ­c kompilace mÃ¡ spoustu zÃ¡vislostÃ­. Proto pouÅ¾Ã­vÃ¡m pypy z repozitÃ¡Å™e (<code>sudo apt install pypy</code>) a vyuÅ¾Ã­vÃ¡m jen nejnovÄ›jÅ¡Ã­ <em>RPython toolkit</em>, kterÃ½ je s pypy distribuovanÃ½.</p>
      <p id="fb56c6c8-92d4-48aa-852c-8220432702c8" class="">Jakmile mÃ¡m pypy nainstalovanÃ©, stÃ¡hnu si jeÅ¡tÄ› PIP (python package manager) pro pypy (standardnÃ­ funguje jen pro cpython):</p>
      <pre id="5de25e4b-568a-499e-8abf-ff75bc9a1336" class="code"><code>curl https://bootstrap.pypa.io/get-pip.py | sudo pypy</code></pre>
      <p id="8308f799-72b3-44eb-a6dd-6f151ed89215" class="">PotÃ© do pypy doinstaluji nejnovÄ›jÅ¡Ã­ verzi parsovacÃ­ho balÃ­ku <a href="https://github.com/alex/rply">rply</a>:</p>
      <pre id="9461fd58-0e54-4335-b7e1-733d49f312f5" class="code"><code>pypy -m pip install --user rply</code></pre>
      <p id="935d4a2c-4387-44f2-a2f5-4f19f5539da0" class="">V repozitÃ¡Å™i debian based systÃ©mÅ¯ se nachÃ¡zÃ­ balÃ­k pypy-rply, kterÃ½ ale nedoporuÄuji pouÅ¾Ã­vat, protoÅ¾e mÅ¯Å¾e bÃ½t zastaralÃ½ vÅ¯Äi PIPu (v dobÄ› psanÃ­ ÄlÃ¡nku je v debian repozitÃ¡Å™i verze 0.7.4-3 a v pipu 0.7.5).</p>
      <h1 id="6f10e555-8c51-40cd-a90a-07bd77dff1d9" class="">target.py</h1>
      <p id="11a1eba8-07b3-467d-848d-f27ee95c4728" class="">PouÅ¡tÄ›nÃ½ script <a href="http://target.py"><code>target.py</code></a> definuje vstupnÃ­ kompilaÄnÃ­ bod. V nÄ›m musÃ­ bÃ½t minimÃ¡lnÄ› dvÄ› funkce - <code>target()</code> a potÃ© funkce kterÃ¡ slouÅ¾Ã­ jako vstupnÃ­ bod spuÅ¡tÄ›nÃ©ho programu. V podstatÄ› se jednÃ¡ o takovÃ© <code>meta-main()</code> znÃ¡mÃ© z C jazykÅ¯, tedy funkci urÄujÃ­cÃ­ funkci main. MÃ¡m pocit, Å¾e na linuxu se k tomu pod libc <a href="https://stackoverflow.com/questions/15919356/c-program-start">bÄ›Å¾nÄ› pouÅ¾Ã­vÃ¡</a> __start.</p>
      <p id="e6826aaf-91c6-47fa-8c4c-2cdb8aeac878" class="">Obsah funkce <code>target()</code> se spouÅ¡tÃ­ v dobÄ› pÅ™ekladu a proto je moÅ¾nÃ© v nÄ›m provÃ¡dÄ›t rÅ¯znÃ© meta-programovÃ¡nÃ­, napÅ™Ã­klad volat funkce, kterÃ© vygenerujÃ­ funkce, kterÃ© jsou potÃ© zkompilovÃ¡ny.</p>
      <p id="3fd1c62b-d739-487d-b1e4-e4e73070b668" class="">OsobnÄ› jsem do zaÄÃ¡tku pouÅ¾il jen nejjednoduÅ¡Å¡Ã­ target.py:</p>
      <pre id="847fa0ba-2d70-4a30-ac5f-9c56a9758dee" class="code"><code>#! /usr/bin/env python2
# -*- coding: utf-8 -*-
from rpython.jit.codewriter.policy import JitPolicy
from parser import lex_and_parse


def main(argv):
    print lex_and_parse("1")
    return 1


def target(driver, args):
    return main, None


def jitpolicy(driver):
    return JitPolicy()


def untranslated_main():
    import sys
    sys.exit(main(sys.argv))


if __name__ == '__main__':
    untranslated_main()</code></pre>
      <p id="f069e582-5bd6-4ecc-8ba0-ae65db0b7773" class="">Jak je vidÄ›t, jen se pustÃ­ funkce <code>lex_and_parse("1")</code>, tedy pokus o zparsovÃ¡nÃ­ zdrojovÃ©ho kÃ³du obsahujÃ­cÃ­ho jen ÄÃ­slo jedna.</p>
      <p id="d5153cb7-9a19-47c0-8f98-8982ac6d1540" class="">Pokud by vÃ¡s zajÃ­mal princip fungovÃ¡nÃ­ pÅ™ekladu na C kÃ³d, tak znovu doporuÄuji nÃ¡sledujÃ­cÃ­ odkazy:</p>
      <ul id="c7a4d905-0444-454c-ba72-0d4679b442fe" class="bulleted-list">
        <li>
          <a href="https://www.root.cz/clanky/rpython-prekvapive-vykonny-dialekt-pythonu-na-nemz-je-zalozen-pypy/">RPython: pÅ™ekvapivÄ› vÃ½konnÃ½ dialekt Pythonu, na nÄ›mÅ¾ je zaloÅ¾en PyPy</a>
        </li>
      </ul>
      <ul id="3de93987-2796-45c4-87c1-7a02b69a0ea4" class="bulleted-list">
        <li>
          <a href="https://rpython.readthedocs.io/en/latest/translation.html">The RPython Toolchain</a>
        </li>
      </ul>
      <p id="6861fdd3-e634-418d-ab69-123838d3bb26" class="">Hezky to celÃ© shrnuje nÃ¡sledujÃ­cÃ­ graf:</p>
      <figure id="b47eeec8-6d29-4e48-a7c7-f804da5eaf1f" class="image">
        <a href="https://rpython.readthedocs.io/en/latest/_images/translation-detail-0.9.png"><img src="https://rpython.readthedocs.io/en/latest/_images/translation-detail-0.9.png"></a>
      </figure>
      <p id="4a636dd7-6d3b-46b7-b530-526a3d3920e2" class="">Ve zkratce je vytvoÅ™en <em>flow graf</em> kÃ³du, kterÃ½ je potÃ© projit analyzÃ¡torem datovÃ½ch typÅ¯, jenÅ¾ se snaÅ¾Ã­ jednotlivÃ½m elementÅ¯m pÅ™iÅ™adit statickÃ© datovÃ© typy. Pokud se podaÅ™Ã­, jsou aplikovÃ¡ny optimizace, pÅ™Ã­padnÄ› pÅ™idÃ¡n JIT, vyplivnut C kÃ³d a celÃ© je to zkompilovÃ¡no pomocÃ­ normÃ¡lnÃ­ho C kompilÃ¡toru.</p>
      <p id="bb7c31b9-73d6-4928-87be-86d01692d77a" class="">To Å¾e jde o <em>flow graf</em> ovÅ¡em znamenÃ¡, Å¾e ÄÃ¡sti kÃ³du, kterÃ© nejsou volÃ¡ny nejsou pÅ™eklÃ¡dÃ¡ny. CelÃ© je moÅ¾nÃ© si to pÅ™edstavit jako kompilaci AST, i kdyÅ¾ ve skuteÄnosti se kÃ³d prvnÄ› kompiluje do pythonnÃ­ho bytecode a teprve ten se potÃ© analyzuje a z nÄ›j se stavÃ­ <a href="https://en.wikipedia.org/wiki/Control_flow_graph">control flow graph</a>.</p>
      <p id="efe35440-7761-463b-92d1-99186d2a906f" class="">Prakticky to znamenÃ¡, Å¾e pokud mÃ¡te v objektu metodu, kterou nejde pÅ™eloÅ¾it, tak na to nepÅ™ijdete, dokud v kÃ³du nebude nÄ›kde mÃ­sto, odkud se volÃ¡. Do tÃ© doby vÅ¯bec nenÃ­ souÄÃ¡stÃ­ <em>flow grafu</em>.</p>
      <h1 id="ea604512-a828-4918-ae67-a6bc8a112954" class="">PrvnÃ­ puÅ¡tÄ›nÃ­ testÅ¯</h1>
      <p id="303f23f5-b9c1-4d41-bb15-00b1f80f96ac" class="">PrvnÃ­ puÅ¡tÄ›nÃ­ testÅ¯ mi samozÅ™ejmÄ› neproÅ¡lo:</p>
      <figure id="ef1d019b-bb40-40d7-a67c-39d5ba6e67d5" class="image">
        <a href="Jak_se_pise_programovaci_jazyk_35_RPython/rpython_first_fail.png" title="rpython_first_fail.png"><img style="width:810px" src="Jak_se_pise_programovaci_jazyk_35_RPython/rpython_first_fail.png"></a>
      </figure>
      <p id="ee62a545-6863-47eb-8fb3-b13dcac8a3de" class="">Å½Ã¡dnÃ© pÅ™ekvapenÃ­. Jak jsem psal, RPython pouÅ¾Ã­vÃ¡ silnÄ› omezenou verzi pythonu a mÅ¯j kÃ³d nijak neÅ¡etÅ™Ã­ <em>list comprehensionama</em>, <em>closures</em> a dalÅ¡Ã­mi â€vysokoÃºrovÅˆovÃ½miâ€œ konstrukty.</p>
      <p id="0d03be9d-25b0-4f55-8808-62c3c5e1cc7d" class="">KÃ³d je nynÃ­ zapotÅ™ebÃ­ <em>â€zhloupitâ€œ</em> a pÅ™idat typovÃ© hinty, kterÃ© RPythonu pomohou anotovat <em>flow graph</em> v mÃ­stech, kde si je nedokÃ¡Å¾e odvodit sÃ¡m.</p>
      <h2 id="ec75f321-da4b-4abf-b46b-1babf9215362" class="">Redukce na RPython</h2>
      <p id="4cec8392-13ac-44e2-80f9-c581ae4cd3de" class="">NynÃ­ musÃ­m vzÃ­t dynamickÃ½ a relativnÄ› vyskoÃºrovÅˆovÃ½ python a pÅ™evÃ©st ho na staticky typovanÃ½ kÃ³d, kterÃ½ by se psal podobnÄ› jako tÅ™eba v JavÄ›. To vÅ¡e ÄistÄ› v syntaxi pythonu.</p>
      <p id="ea94e078-c1d1-4357-ae96-fb09574fc9b3" class="">ÄŒÃ¡st omezenÃ­ je popsÃ¡na v oficiÃ¡lnÃ­ dokumentaci:</p>
      <ul id="25287908-382c-491a-9bc4-086c00794a2c" class="bulleted-list">
        <li>
          <a href="http://rpython.readthedocs.io/en/latest/rpython.html">RPython Language</a>
        </li>
      </ul>
      <p id="b2245aa6-2444-4b41-a9c1-770c588f00b3" class="">Mnohem lepÅ¡Ã­ pÅ™edstavu vÅ¡ak dÃ¡vÃ¡ ÄlÃ¡nek</p>
      <ul id="6dbd927b-3546-4571-8e4d-6e43695a5177" class="bulleted-list">
        <li>
          <a href="https://refi64.com/posts/the-magic-of-rpython.html">The Magic of RPython</a> (<a href="http://web.archive.org/web/20180317140809/https://refi64.com/posts/the-magic-of-rpython.html">webarchive</a>)
        </li>
      </ul>
      <p id="03c8c121-24fe-409e-bf94-e7a01e2e1d91" class="">Mezi vÃ½znamnÃ¡ omezenÃ­ patÅ™Ã­ napÅ™Ã­klad omezenÃ­ promÄ›nnÃ½ch pouze na jeden datovÃ½ typ v danÃ©m <em>scope</em>. To znamenÃ¡, Å¾e do nich nemÅ¯Å¾ete pÅ™iÅ™adit hodnotu s jinÃ½m datovÃ½m typem, jakmile je jednou pouÅ¾ijete. Seznamy musÃ­ bÃ½t celÃ© tvoÅ™eny z jednoho datovÃ©ho typu. Closures nefungujÃ­ vÅ¯bec. List comprehensions fungujÃ­, ale ne ÃºplnÄ› tak jak by ÄlovÄ›k Äekal. GenerÃ¡tory jsou vÃ­ce/mÃ©nÄ› podporovÃ¡ny, ale nejdou s nimi dÄ›lat rÅ¯znÃ© psÃ­ kusy, jako tÅ™eba kompozice.</p>
      <p id="f76a9371-e624-4188-a449-4dd1a383006c" class="">OtravnÄ› omezujÃ­cÃ­ je nutnost vÅ¡ech funkcÃ­ v parseru vracet stejnÃ½ datovÃ½ typ, resp. tÅ™Ã­du odvozenou od stejnÃ©ho datovÃ©ho typu. <code>rply</code> k tomu nabÃ­zÃ­ <a href="https://github.com/alex/rply/blob/master/rply/token.py#L1">rply.token.BaseBox</a>, od kterÃ© musÃ­ bÃ½t podÄ›dÄ›ny vÅ¡echny AST prvky. NavÃ­c je vÅ¡ak ale tÅ™eba pÅ™epsat i vÅ¡echny parsovacÃ­ funkce tak, aby nevracely <code>list</code>, <code>dict</code>, nebo jinÃ© nativnÃ­ typy, ale datovÃ½ typ odvozenÃ½ od <code>BaseBox</code>u.</p>
      <p id="5a0ffda4-eb3a-4d68-a480-2d5ca8543316" class="">Proto jsem byl nucen nadefinovat tÅ™Ã­dy <code>StrContainer</code>, <code>DictContainer</code>, <code>ListContainer</code> a <code>KwSlotContainer</code>, a pouÅ¾Ã­vat je na mÃ­stech, kde jsem dÅ™Ã­ve pouÅ¾Ã­val prostÄ› jen <code>dict</code>, nebo <code>list</code>. PÅ¯vodnÄ› jsem chtÄ›l pouÅ¾Ã­t jen Container, kterÃ½ by udrÅ¾oval obecnÃ½ datovÃ½ typ, ale ukÃ¡zalo se, Å¾e na nÄ›j taky platÃ­ omezenÃ­ a pro jednu instanci je moÅ¾nÃ© pouÅ¾Ã­t jen jeden datovÃ½ typ. Do tÅ™Ã­dy ve stylu:</p>
      <pre id="5cc5e5a0-0577-479e-9fde-89f87c5bf312" class="code"><code>class Container(object):
  def __init__(self, data):
    self.data = data</code></pre>
      <p id="ce7de1d9-5e6b-4feb-bef9-9675de086509" class="">nenÃ­ moÅ¾nÃ© v rÅ¯znÃ½ch instancÃ­ch uloÅ¾it rÅ¯znÃ© datovÃ© typy. To je pro mÄ› jakoÅ¾to dlouhodobÃ©ho programÃ¡tora v pythonu docela nezvyk.</p>
      <p id="6593d087-a9fc-4a71-aa6e-e881002758ab" class="">Hezky je to vidÄ›t napÅ™Ã­klad na parsovacÃ­ funkci <code>kw_slot_definition()</code>, kterÃ¡ se promÄ›nila z</p>
      <pre id="7e98f4ef-ef69-48e2-9f68-ff90324b49b6" class="code"><code>@pg.production('slot_definition : kw_slot_name ASSIGNMENT expression')
def kw_slot_definition(p):
    assert isinstance(p[2], Object), "Only objects are assignable to kw slots!"

    slot_name = p[0][0]
    parameters = p[0][1]

    obj = p[2]
    obj.params.extend(parameters)

    return {slot_name: obj}</code></pre>
      <p id="8eb34dc5-8861-439d-a3c7-9d69c2554459" class="">na</p>
      <pre id="913b749f-2263-44c1-8c5b-391fda43ca59" class="code"><code>@pg.production('slot_definition : kw_slot_name ASSIGNMENT expression')
def kw_slot_definition(p):
    slot_info = p[0]
    obj = p[2]

    assert isinstance(slot_info, KwSlotContainer)
    assert isinstance(obj, Object)

    obj.params.extend(slot_info.parameters)

    return DictContainer({slot_info.slot_name: obj})</code></pre>
      <p id="e6dc9ff0-a859-4905-9d25-ccbb77562d79" class="">Za povÅ¡imnutÃ­ stojÃ­ takÃ© nÄ›kolik pouÅ¾itÃ­ <code>assert isinstance(..)</code>. V prvnÃ­m pÅ™Ã­padÄ› pouÅ¾Ã­vÃ¡m <code>assert</code> tak, jak byl zamÃ½Å¡len, tedy k ujiÅ¡tÄ›nÃ­ se, Å¾e do funkce nepoleze datovÃ½ typ jinÃ½ neÅ¾ objekt a pokud ano, tak vyhodÃ­m chybovou hlÃ¡Å¡ku.</p>
      <p id="6d9a221e-2a05-419e-ad6d-c135a2513e9b" class="">Ve druhÃ©m pÅ™Ã­padÄ› <code>assert</code> nefunguje jako pÅ™Ã­kaz pro ujiÅ¡tÄ›nÃ­, ale jako <em>type hint</em> (<em>typovÃ¡ nÃ¡povÄ›da</em>) pro RPython, kterÃ½ mu Å™Ã­kÃ¡, jakÃ©ho datovÃ©ho typu jsou danÃ© parametry. Pokud bych ho neuvedl, doÅ¡lo by v dobÄ› pÅ™ekladu k vyhozenÃ­ vÃ½jimky, kterÃ¡ mÅ¯Å¾e vypadat napÅ™Ã­klad takto:</p>
      <pre id="1891ff42-99c2-4cf5-b842-348dd417ecbc" class="code"><code>[translation:ERROR] NoSuchAttrError: 

the attribute 'params' goes here to &lt;ClassDef 'rply.token.BaseBox'&gt;, but it is forbidden here


    v0 = getattr(obj_0, ('params'))

In &lt;FunctionGraph of (parser:453)kw_slot_definition at 0x55b7e3841cc8&gt;:
Happened at file src/tinySelf/parser.py line 461

        slot_info = p[0]
        obj = p[2]
    
        # assert isinstance(slot_info, KwSlotContainer)
        # assert isinstance(obj, Object)
    
==&gt;     obj.params.extend(slot_info.parameters)
    
        return DictContainer({slot_info.slot_name: obj})</code></pre>
      <p id="49c65f87-61bb-4fc0-899a-07138ffe8af0" class="">Z chyby je jasnÄ› vidÄ›t, Å¾e RPython nechÃ¡pe, proÄ se snaÅ¾Ã­m u neznÃ¡mÃ©ho objektu pÅ™istupovat k ÄlenskÃ© promÄ›nnÃ© <code>params</code>.</p>
      <p id="d9211181-94ee-458c-8da2-2a3dc4e55809" class="">Na konci funkce pak vracÃ­m <code>DictContainer</code> ÄistÄ› jen proto, Å¾e vrÃ¡cenÃ© parsovanÃ© hodnoty musÃ­ bÃ½t vÅ¡echny stejnÃ½m datovÃ½m typem, nebo jeho potomky. To je zpÅ¯sobeno vnitÅ™nÃ­m fungovÃ¡nÃ­m parseru, kterÃ½ jednotlivÃ© odekorovanÃ© funkce zpracovÃ¡vÃ¡ v rÅ¯znÃ½ch kolekcÃ­ch, ve kterÃ½ch nemÅ¯Å¾ou bÃ½t pod RPythonem rÅ¯znÃ© datovÃ© typy.</p>
      <p id="7238ea02-8f98-405a-a238-bd39742dde4b" class="">ZajÃ­mavÃ© jsou chyby <code>Blocked block -- operation cannot succeed</code>, kterÃ© mi jeden veÄer docela zamotaly hlavu. Nakonec jsem vÅ¡ak prohledÃ¡nÃ­m konference zjistil, Å¾e se jednÃ¡ o chybu kdyÅ¾ RPython type annotator prvnÄ› vleze do metody objektu a jeÅ¡tÄ› neproÅ¡el <code>.__init__()</code> metodu. Pokud je v metodÄ› pÅ™istoupeno k ÄlenskÃ½m promÄ›nnÃ½m, tak dojde chybÄ›, jelikoÅ¾ anotÃ¡tor nevÃ­ o tom Å¾e byly definovÃ¡ny. Å˜eÅ¡enÃ­ je docela prostÃ©, staÄÃ­ objekt prostÄ› pÅ™edtÃ­m nÄ›kde pouÅ¾Ã­t, aby byla o-anotovÃ¡na <code>.__init__()</code> metoda.</p>
      <h2 id="9a496d5f-10b9-4da6-8548-ab9f084c167c" class="">PÅ™eklad</h2>
      <p id="2fae3c5e-830a-43f3-b387-52b44fec2f00" class="">VÃ½Å¡e uvedenÃ© potÃ­Å¾e jsou jen malÃ¡ ÄÃ¡st toho, s ÄÃ­m se ÄlovÄ›k setkÃ¡. OsobnÄ› jsem postupoval tak, Å¾e jsem celÃ½ parser aÅ¾ na prvnÃ­ pravidlo a poslednÃ­ parsovacÃ­ funkci <code>parse_and_lex()</code> zakomentoval a postupnÄ› pÅ™evÃ¡dÄ›l jednotlivÃ¡ pravidla. TÃ­mhle postupem mi to trvalo pomÄ›rnÄ› dlouho, ale nakonec se dostavil vÃ½sledek:</p>
      <figure id="ec340534-cd5a-4762-8984-d8ba71ea1ed5" class="image">
        <a href="Jak_se_pise_programovaci_jazyk_35_RPython/compilation.gif" title="compilation.gif"><img style="width:896px" src="Jak_se_pise_programovaci_jazyk_35_RPython/compilation.gif"></a>
      </figure>
      <p id="6b05db44-5d5b-4a62-98a3-9b29fe5f70cd" class=""><em>(KompilaÄnÃ­ fraktÃ¡ly v pÅ¯vodnÃ­ kvalitÄ›:</em> <em><a href="https://youtu.be/A_OhtmUH830">https://youtu.be/A_OhtmUH830</a></em><em>)</em></p>
      <h1 id="ea87c7ac-48fb-4ba0-af65-7c044bf42bb0" class="">PokraÄovÃ¡nÃ­</h1>
      <p id="090d3364-ee9f-48d2-a3bf-497ee5bf0195" class="">PÅ™Ã­Å¡tÄ› se podÃ­vÃ¡me na nÃ¡vrh rozloÅ¾enÃ­ a reprezentace objektÅ¯ v pamÄ›ti pÅ™ed tÃ­m, neÅ¾ pÅ™ijde na Å™adu psanÃ­ virtuÃ¡lnÃ­ho stroje a kompilÃ¡toru do bytecode.</p>
      <h1 id="b1e1c147-14bb-4424-82bb-bdf222a7c238" class="">RelevantnÃ­ diskuze</h1>
      <ul id="46b4620c-c297-4e75-926b-094e212b43ab" class="bulleted-list">
        <li>
          <a href="http://www.abclinuxu.cz/blog/bystroushaak/2019/2/jak-se-pise-programovaci-jazyk-3.5-rpython">Jak se pÃ­Å¡e programovacÃ­ jazyk 3.5: RPython</a> (abclinuxu)
        </li>
      </ul>
      <p id="8b29ea42-1b6a-4753-90cc-41593cf8831a" class=""></p>
    </div>
  </article>
  <div class="corner-ribbon top-right red">
    <a href="https://www.patreon.com/bePatron?u=2618881">Become a Patron</a>
  </div><a class="twitter-share-button" id="twitter_button" href="#"><img src="../../../tweet_button.svg"></a>
  <div id="sidebar_bottom">
    <span><a href="https://blog.rfox.eu/atom_cz.xml"><img style="width: 3em;" src="../../../rss_icon.png"></a> &nbsp; &nbsp; <a href="https://twitter.com/Bystroushaak"><img style="width: 3em;" src="../../../twitter_icon.png"></a></span>
    <div id="last_five_bottom">
      <h3>New posts</h3>
      <ul>
        <li>
          <a href="../../Predstaveni/Mikrotron_pod_Vitkovem.html" title="Mikrotron pod VÃ­tkovem">Mikrotron pod VÃ­tkovem</a>
        </li>
        <li>
          <a href="../../Predstaveni/GPT-3.html" title="GPT-3">GPT-3</a>
        </li>
        <li>
          <a href="https://blog.rfox.eu/atom_cz.xml">VytvoÅ™en novÃ½ Atom (RSS) feed pro Äeskou sekci</a>
        </li>
      </ul>
    </div>
    <div id="links_from_other_pages">
      <h3>Links to this page:</h3>
      <ul>
        <li>
          <a href="Jak_se_pise_programovaci_jazyk_6_Kompilator_AST_do_bytecode.html" title="Jak se pÃ­Å¡e programovacÃ­ jazyk 6: KompilÃ¡tor AST do bytecode">Jak se pÃ­Å¡e programovacÃ­ jazyk 6: KompilÃ¡tor AST do bytecode</a>
        </li>
      </ul>
    </div>
    <div>
      <h3>Blog categories</h3>
      <ul class="no_icon">
        <li>
          <a href="../../Programovani.html" title="ProgramovÃ¡nÃ­">ğŸ“‚ ProgramovÃ¡nÃ­</a>
        </li>
        <li>
          <a href="../../Knihy.html" title="Knihy">ğŸ“‚ Knihy</a>
        </li>
        <li>
          <a href="../../Predstaveni.html" title="PÅ™edstavenÃ­">ğŸ“‚ PÅ™edstavenÃ­</a>
        </li>
        <li>
          <a href="../../Abclinuxu.html" title="Abclinuxu">ğŸ“‚ Abclinuxu</a>
        </li>
        <li>
          <a href="../../Ostatni.html" title="OstatnÃ­">ğŸ“‚ OstatnÃ­</a>
        </li>
        <li>
          <a href="../../Povidky.html" title="PovÃ­dky">ğŸ“‚ PovÃ­dky</a>
        </li>
        <li>
          <a href="../../Hrbitov.html" title="HÅ™bitov">ğŸ“‚ HÅ™bitov</a>
        </li>
        <li>
          <a href="../../index.html" title="Czech section">ğŸ“‚ Czech section</a>
        </li>
      </ul>
    </div>
  </div>
</body>
</html>
