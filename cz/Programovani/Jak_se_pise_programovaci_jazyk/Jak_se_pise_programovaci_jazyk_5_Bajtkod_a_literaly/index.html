<!DOCTYPE html>
<html>
<head>
  <meta name="generator" content="HTML Tidy for HTML5 for Linux version 5.2.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Jak se pÃ­Å¡e programovacÃ­ jazyk 5: BajtkÃ³d a literÃ¡ly</title>
  <link rel="stylesheet" type="text/css" href="../../../../style.css">
  <link rel="alternate" type="application/atom+xml" href="https://blog.rfox.eu/atom_cz.xml">
  <link rel="shortcut icon" href="/favicon.ico">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@Bystroushaak">
  <meta name="twitter:creator" content="@Bystroushaak">
  <meta name="twitter:title" content="Jak se pÃ­Å¡e programovacÃ­ jazyk 5: BajtkÃ³d a literÃ¡ly">
  <meta name="twitter:description" content="Lexer rozdÄ›luje vstupnÃ­ text na tokeny, kterÃ© jsou parserem transformovÃ¡ny na abstraktnÃ­ syntaktickÃ© stromy. Ty by mÄ›l vzÃ­t kompilÃ¡tor a udÄ›lat z nich bajtkÃ³d. PÅ™edtÃ­m je ovÅ¡em nutnÃ© si dÅ¯kladnÄ› rozmyslet, jak mÃ¡ vlastnÄ› vÃ½slednÃ½ bajtkÃ³d vypadat, a tedy hlavnÄ› jak mÃ¡ vypadat virtuÃ¡lnÃ­ stroj, kterÃ½m bude interpretovÃ¡n.">
  <meta name="twitter:image" content="https://blog.rfox.eu/cz/Programovani/Jak_se_pise_programovaci_jazyk/Jak_se_pise_programovaci_jazyk_5_Bajtkod_a_literaly/code_context.png">
  <script src="../../../../scripts.js">
  </script>
  <meta name="description" content="Lexer rozdÄ›luje vstupnÃ­ text na tokeny, kterÃ© jsou parserem transformovÃ¡ny na abstraktnÃ­ syntaktickÃ© stromy. Ty by mÄ›l vzÃ­t kompilÃ¡tor a udÄ›lat z nich bajtkÃ³d. PÅ™edtÃ­m je ovÅ¡em nutnÃ© si dÅ¯kladnÄ› rozmyslet, jak mÃ¡ vlastnÄ› vÃ½slednÃ½ bajtkÃ³d vypadat, a tedy hlavnÄ› jak mÃ¡ vypadat virtuÃ¡lnÃ­ stroj, kterÃ½m bude interpretovÃ¡n."><!-- Global site tag (gtag.js) - Google Analytics -->

  <script src="https://www.googletagmanager.com/gtag/js?id=UA-142545439-1">
  </script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-142545439-1');
  </script>
</head>
<body onload="on_body_load();">
  <div id="sidebar_top">
    <span><a href="https://blog.rfox.eu/atom.xml"><img style="width: 3em;" src="../../../../rss_icon.png"></a> &nbsp; &nbsp; <a href="https://twitter.com/Bystroushaak"><img style="width: 3em;" src="../../../../twitter_icon.png"></a></span>
    <div id="last_five_top">
      <h3>New posts</h3>
      <ul>
        <li>
          <a href="../../../Predstaveni/GPT-3.html" title="GPT-3">GPT-3</a>
        </li>
        <li>
          <a href="https://blog.rfox.eu/atom_cz.xml">VytvoÅ™en novÃ½ Atom (RSS) feed pro Äeskou sekci</a>
        </li>
      </ul>
    </div>
    <div>
      <h3>Blog categories</h3>
      <ul class="no_icon">
        <li>
          <a href="../../../Programovani.html" title="ProgramovÃ¡nÃ­">ğŸ“‚ ProgramovÃ¡nÃ­</a>
        </li>
        <li>
          <a href="../../../Knihy.html" title="Knihy">ğŸ“‚ Knihy</a>
        </li>
        <li>
          <a href="../../../Predstaveni.html" title="PÅ™edstavenÃ­">ğŸ“‚ PÅ™edstavenÃ­</a>
        </li>
        <li>
          <a href="../../../Povidky.html" title="PovÃ­dky">ğŸ“‚ PovÃ­dky</a>
        </li>
        <li>
          <a href="../../../Hrbitov.html" title="HÅ™bitov">ğŸ“‚ HÅ™bitov</a>
        </li>
        <li>
          <a href="../../../Ostatni.html" title="OstatnÃ­">ğŸ“‚ OstatnÃ­</a>
        </li>
        <li>
          <a href="../../../Abclinuxu.html" title="Abclinuxu">ğŸ“‚ Abclinuxu</a>
        </li>
        <li>
          <a href="../../../index.html" title="Czech section">ğŸ“‚ Czech section</a>
        </li>
      </ul>
    </div>
  </div><a class="breadcrumb" href="../../../../index.html" title="Bystroushaak's blog">Bystroushaak's blog</a> / <a class="breadcrumb" href="../../../index.html" title="Czech section">Czech section</a> / <a class="breadcrumb" href="../../index.html" title="ProgramovÃ¡nÃ­">ProgramovÃ¡nÃ­</a> / <a class="breadcrumb" href="../index.html" title="Jak se pÃ­Å¡e programovacÃ­ jazyk">Jak se pÃ­Å¡e programovacÃ­ jazyk</a> / Jak se pÃ­Å¡e programovacÃ­ jazyk 5: BajtkÃ³d a literÃ¡ly
  <article id="9532731e-b55e-4d24-81ff-fed23e1dc32e" class="page sans">
    <header>
      <h1 class="page-title">Jak se pÃ­Å¡e programovacÃ­ jazyk 5: BajtkÃ³d a literÃ¡ly</h1>
    </header>
    <div class="page-body">
      <p id="8b9fcd90-6b9a-4352-8f35-f422f38d0a20" class=""><time>@2019/04/18</time></p>
      <p id="cf59ce1a-7bab-491e-a997-08176389c8ac" class="">Lexer rozdÄ›luje vstupnÃ­ text na tokeny, kterÃ© jsou parserem transformovÃ¡ny na abstraktnÃ­ syntaktickÃ© stromy. Ty by mÄ›l vzÃ­t kompilÃ¡tor a udÄ›lat z nich bajtkÃ³d. PÅ™edtÃ­m je ovÅ¡em nutnÃ© si dÅ¯kladnÄ› rozmyslet, jak mÃ¡ vlastnÄ› vÃ½slednÃ½ bajtkÃ³d vypadat, a tedy hlavnÄ› jak mÃ¡ vypadat virtuÃ¡lnÃ­ stroj, kterÃ½m bude interpretovÃ¡n.</p>
      <p id="fe8f0e0c-ba1e-485f-bf8c-2eb875637da5" class="">Jak uÅ¾ jsem zmiÅˆoval, nejsem ani v nejmenÅ¡Ã­m odbornÃ­k na tvorbu programovacÃ­ch jazykÅ¯. KdyÅ¾ jsem se pustil do psanÃ­ specifikace VM, byly mi znÃ¡mÃ© nÃ¡sledujÃ­cÃ­ pÅ™Ã­stupy:</p>
      <ol id="353dfee0-f421-4e4b-aec7-cddb1a70a127" class="numbered-list" start="1">
        <li>Interpretace AST</li>
      </ol>
      <ol id="caa0fa03-8b5e-431d-8b40-ec10218f9f96" class="numbered-list" start="2">
        <li>Interpretace imperativnÃ­ho bajtkÃ³du</li>
      </ol>
      <ol id="391fed5f-22de-410d-b933-bc884c289b04" class="numbered-list" start="3">
        <li>Interpretace <em>stack based</em> bajtkÃ³du</li>
      </ol>
      <p id="6be00d3e-7afe-4daf-9a35-7b342b1aa181" class="">Pavel KÅ™ivÃ¡nek ve svÃ© bakalÃ¡Å™skÃ© prÃ¡ci <a href="http://kitakitsune.org/ltas/resources/Podpora_beztridniho_programovani_ve_Squeak_Smalltalku.pdf">Podpora beztÅ™Ã­dnÃ­ho programovÃ¡nÃ­ ve Squeak Smalltalku</a> pouÅ¾il pro svÅ¯j Selfem inspirovanÃ½ jazyk Marvin <em>stack based</em> (na zÃ¡sobnÃ­ku zaloÅ¾enÃ½) bajtkÃ³d ve stylu forthu.</p>
      <p id="42a572a5-6ac4-4faf-8bd8-123397ca6b22" class="">Oproti tomu <a href="https://pdfs.semanticscholar.org/7a9f/b345d1372f99c47f68fbcf5187f10af87704.pdf">The Design and Implementation of the Self Compiler, an Optimizing Compiler for Object-Oriented Programming Languages</a> (dÃ¡le jen <em>DISCOCOOPL</em>) zmiÅˆuje spÃ­Å¡e imperativnÃ­ bajtkÃ³d ve stylu assembleru.</p>
      <p id="342482d0-1e71-4076-9c19-7f2415dd6725" class="">V krÃ¡tkÃ© vÃ½mÄ›nÄ› mailÅ¯, kterÃ© jsem Pavlovi KÅ™ivÃ¡nkovi poslal zmiÅˆoval, abych zkusil zkombinovat prvnÃ­ a druhÃ½ pÅ™Ã­stup.</p>
      <p id="a82cb61f-3cd3-4870-863d-03869b85534a" class="">DÃ¡le zde byly dva projekty <em>SmalltalkÅ¯</em> napsanÃ½ch v RPythonu:</p>
      <ol id="2716b212-5e65-4e9b-8b95-937657314f29" class="numbered-list" start="1">
        <li>
          <a href="https://github.com/SOM-st/RPySOM">https://github.com/SOM-st/RPySOM</a>
        </li>
      </ol>
      <ol id="069d45b3-694c-43c9-bf65-c14363fbdb8f" class="numbered-list" start="2">
        <li>
          <a href="https://github.com/hpi-swa/RSqueak">https://github.com/hpi-swa/RSqueak</a> (viz paper <a href="https://www.hpi.uni-potsdam.de/hirschfeld/publications/media/FelgentreffPapeReinHirschfeld_2016_HowToBuildAHighPerformanceVmForSqueakSmalltalkInYourSpareTimeAnExperienceReportOfUsingTheRPythonToolchain_AcmDL.pdf">How to Build a High-Performance VM for Squeak/Smalltalk in Your Spare Time</a>)
        </li>
      </ol>
      <p id="5616ac9d-946a-45db-9364-c78e7610d171" class="">Oba dva slouÅ¾ily jako lehkÃ¡ technickÃ¡ inpisrace pÅ™i tvorbÄ› interpretru.</p>
      <h2 id="1a24d315-c343-4abb-b2df-e0272344b779" class="">Souslednost</h2>
      <p id="889ab8f9-f4ac-4f7d-88ad-ba40f16c4312" class="">Za zmÃ­nku pravdÄ›podobnÄ› stojÃ­, Å¾e tato a nÃ¡sledujÃ­cÃ­ dvÄ› kapitoly byly psÃ¡ny aÅ¾ po dokonÄenÃ­ vÄ›tÅ¡iny prÃ¡ce na bajtkÃ³dech, interpreteru a kompilÃ¡toru. PrÃ¡ce na tÄ›chto komponentÃ¡ch vÅ¡ak probÃ­hala zÃ¡roveÅˆ a jednalo se do jistÃ© mÃ­ry o iterativnÃ­ proces. ÄŒlovÄ›k pÅ™idÃ¡ jeden parametr bajtkÃ³du, upravÃ­ kompilÃ¡tor a interpreter a hned vidÃ­, Å¾e to ovlivnilo celkovÃ½ obraz tak, Å¾e nynÃ­ nenÃ­ tÅ™eba kousek tady a je tÅ™eba pÅ™idat kousek tÃ¡mhle, coÅ¾ vede ke zmÄ›nÃ¡m v kompilÃ¡toru tady a tÃ¡mhle, dÃ­ky ÄemuÅ¾ nenÃ­ tÅ™eba v interpretru tohle a tÃ¡mhleto mÅ¯Å¾e fungovat jinak..</p>
      <p id="0e322e3d-5b4f-4b67-91c4-e15b50e5f395" class="">VytvÃ¡Å™et nÄ›co, kde se zÃ¡roveÅˆ tÅ™i a vÃ­ce komponent ovlivÅˆuje, a bez samotnÃ© implementace se dopÅ™edu tÄ›Å¾ko pÅ™edstavuje, jak konkrÃ©tnÄ› by to mÄ›lo celÃ© vypadat, je zajÃ­mavÃ¡ zkuÅ¡enost. NynÃ­ pÅ™i psanÃ­ zpÄ›tnÄ› vidÃ­m, jak se to celÃ© podepsalo na celkovÃ© podobÄ› interpretru a hned mÄ› napadÃ¡, Å¾e by Å¡lo upravit spoustu komponent trochu jinak.</p>
      <p id="a722a6ab-a24f-4e31-807b-351d4a3dad84" class="">VÃ½voj, a zde a v nÃ¡sledujÃ­cÃ­ch kapitolÃ¡ch popsanÃ¡ podoba, byla ovÅ¡em diktovÃ¡na snahou o co nejrychlejÅ¡Ã­ bootstrapping, s tÃ­m Å¾e na optimalizace a Ãºpravy bude dost Äasu pozdÄ›ji, pokud projekt vyhodnotÃ­m jako hodnÃ½ dalÅ¡Ã­ho pokraÄovÃ¡nÃ­.</p>
      <h2 id="2c49cd4a-eb8d-4bbe-b0cb-adf314b4e3ac" class="">LiterÃ¡ly</h2>
      <p id="f88784d2-5b5d-46b4-9ab7-6ed96d1f6750" class="">BajtkÃ³d se nesklÃ¡dÃ¡ pouze z jednotlivÃ½ch instrukcÃ­, sklÃ¡dÃ¡ se takÃ© z tabulky literÃ¡lÅ¯. V tÃ© jsou uloÅ¾eny vÅ¡echny konstantnÃ­ hodnoty znÃ¡mÃ© v dobÄ› kompilace.</p>
      <p id="02c6e1db-b51b-418d-b720-3d13ea300830" class="">Mezi nÄ› patÅ™Ã­:</p>
      <ul id="e161e116-54ef-45ca-b94e-8189536866ed" class="bulleted-list">
        <li>Å˜etÄ›zce</li>
      </ul>
      <ul id="043a27ef-775c-4c91-9f9d-d24782cc5343" class="bulleted-list">
        <li>ÄŒÃ­sla</li>
      </ul>
      <ul id="85e14e6a-10e2-487d-9387-4f55d3480394" class="bulleted-list">
        <li>Nil</li>
      </ul>
      <ul id="0307f7bc-ebf1-40f0-9735-c59043945323" class="bulleted-list">
        <li>Object</li>
      </ul>
      <ul id="ac4d20ca-aac8-454d-89d2-92faba47353a" class="bulleted-list">
        <li>Block</li>
      </ul>
      <ul id="29e4a925-21d4-4915-bd9f-631b911b5907" class="bulleted-list">
        <li>Assignment primitive</li>
      </ul>
      <p id="eb6d7f2c-8cd4-47f5-9341-25d95095ce99" class="">KdyÅ¾ pak interpreter dojde na ÄÃ¡st kde je nutnÃ© pouÅ¾Ã­t nÄ›jakÃ½ literÃ¡l, nemusÃ­ ho v tu chvÃ­li rekonstruovat z bajtkÃ³du, mÃ­sto toho se jednoduÅ¡e podÃ­vÃ¡ do tabulky literÃ¡lÅ¯ na patÅ™iÄnÃ½ index a vytvoÅ™Ã­ podle nÄ›j objekt.</p>
      <h2 id="aba5b2e7-deb0-43ff-a7a2-bc32f225a48e" class="">Bytecodes</h2>
      <p id="911f2b21-9ec9-4578-b72b-61015b965de0" class="">Pavel KÅ™ivÃ¡nek navrhoval pro Marvina nÃ¡sledujÃ­cÃ­ bajtkÃ³dy:</p>
      <ul id="d1baa76e-5ff7-4baa-8217-45a09016bbf7" class="bulleted-list">
        <li><strong>send:</strong> ZaÅ¡le objektu na vrcholu zÃ¡sobnÃ­ku zprÃ¡vu identifikovanou urÄitÃ½m selektorem.</li>
      </ul>
      <ul id="819a1d72-1ac9-4799-8df2-795ac4908554" class="bulleted-list">
        <li><strong>selfSend:</strong> ZaÅ¡le pÅ™Ã­jemci zprÃ¡vu identifikovanou urÄitÃ½m selektorem.</li>
      </ul>
      <ul id="224396a4-0b9f-491b-b04a-5a94208b6da2" class="bulleted-list">
        <li><strong>resend:</strong> ZaÅ¡le pÅ™Ã­jemci zprÃ¡vu identifikovanou urÄitÃ½m selektorem v kontextu pÅ™edka.</li>
      </ul>
      <ul id="5a2403c9-d1c3-4299-9c0d-071001c4e3aa" class="bulleted-list">
        <li><strong>pushSelf</strong> Na vrchol zÃ¡sobnÃ­ku umÃ­stÃ­ pÅ™Ã­jemce zprÃ¡vy.</li>
      </ul>
      <ul id="236e53bb-2097-440f-84eb-75e88e4b4b50" class="bulleted-list">
        <li><strong>pushLiteral:</strong> Na vrchol zÃ¡sobnÃ­ku umÃ­stÃ­ referenci na urÄenÃ½ literÃ¡l.</li>
      </ul>
      <ul id="954086f3-18ae-4af8-896e-1e855a027b6c" class="bulleted-list">
        <li><strong>pop</strong> Odebere jednu poloÅ¾ku z vrcholu zÃ¡sobnÄ±Ìku a zÃ­skanou hodnotu zahodÄ±Ì.</li>
      </ul>
      <ul id="31b9c96d-7c4e-4750-b2f0-b646576e6a0f" class="bulleted-list">
        <li><strong>returnTop</strong> NÃ¡vrat z metody s vrcholem zÃ¡sobnÄ±Ìku jako vÃ½sledkem.</li>
      </ul>
      <ul id="72294e5f-b2b8-4c79-8a80-147614b66f36" class="bulleted-list">
        <li><strong>returnImplicit</strong> ImplicitnÃ­ nÃ¡vrat z kontextu.</li>
      </ul>
      <p id="3c9b46b5-a2d3-4d70-aa39-e052de2c4e1a" class="">OsobnÄ› jsem se tÃ­mto setem hodnÄ› inspiroval, nakonec jsem vÅ¡ak pro nÄ›kterÃ© nenaÅ¡el pouÅ¾itÃ­ a naopak, nÄ›kterÃ© kterÃ© v Marvinovi nebyly mi tam pÅ™iÅ¡ly jako uÅ¾iteÄnÃ©.</p>
      <p id="98aef4b6-7424-4156-8933-8807a6d5623f" class="">Nakonec jsem skonÄil s nÃ¡sledujÃ­cÃ­m setem:</p>
      <ul id="018da1f3-eae3-4508-9d09-9f71a946eda2" class="bulleted-list">
        <li>SEND</li>
      </ul>
      <ul id="5fe76253-135b-4715-b888-156dcfa25d42" class="bulleted-list">
        <li>PUSH_SELF</li>
      </ul>
      <ul id="11dc9017-e233-4db6-b37c-a319f6fa9202" class="bulleted-list">
        <li>PUSH_LITERAL</li>
      </ul>
      <ul id="9287e5a0-de9e-40a2-8972-ab74d906e1f2" class="bulleted-list">
        <li>ADD_SLOT</li>
      </ul>
      <ul id="e9e10028-0acb-4cc6-a730-cb9225e99079" class="bulleted-list">
        <li>RETURN_TOP</li>
      </ul>
      <ul id="3228e19a-16b0-4f6d-9485-52330cb7982a" class="bulleted-list">
        <li>RETURN_IMPLICIT</li>
      </ul>
      <p id="e183e1b9-9a48-46da-96cf-ca074947c83e" class="">PÅ™iÄemÅ¾ nÄ›kterÃ© z nich jsou parametrizovanÃ© a mÅ¯Å¾ou tak zabrat aÅ¾ tÅ™i bajty. Instrukce pracujÃ­ se zÃ¡sobnÃ­kem, na kterÃ½ vklÃ¡dajÃ­, Äi z nÄ›j odebÃ­rajÃ­ hodnoty. ZÃ¡sobnÃ­k je tvoÅ™en zvlÃ¡Å¡Å¥ pro kaÅ¾dou metodu, proto napÅ™Ã­klad chybÃ­ instrukce pro odstranÄ›nÃ­ hodnot ze zÃ¡sobnÃ­ku - vzhledem k tomu Å¾e instrukce hodnoty ze zÃ¡sobnÃ­ku odebÃ­rajÃ­ implicitnÄ›, na konci se prostÄ› celÃ½ zÃ¡sobnÃ­k zahodÃ­, nÄ›kdy s tÃ­m, Å¾e hodnota na vrcholu je vloÅ¾enÃ¡ na vrchol zÃ¡sobnÃ­ku, ze kterÃ©ho vznikl tento.</p>
      <p id="f80bd24c-d708-449d-b07f-285e6cf64919" class="">MusÃ­m Å™Ã­ct, Å¾e mÄ› docela pÅ™ekvapilo, jak mÃ¡lo instrukcÃ­ mi staÄilo. IntuitivnÄ› jsem Äekal, Å¾e jich bude minimÃ¡lnÄ› dvacet. Å½e by mi jich staÄilo Å¡est, respektive pÄ›t bez <code>ADD_SLOT</code>, kterÃ¡ je tam jen protoÅ¾e je to ÄastÃ¡ operace, to mÄ› ani ve snu nenapadlo.</p>
      <h3 id="cb224893-4199-4c92-9857-fef52822d56e" class="">PUSH_LITERAL</h3>
      <p id="f2a501ec-89e5-4b44-b7f3-ac6db2dbec4f" class="">Instrukce, kterou zaÄÃ­nÃ¡ prakticky kaÅ¾dÃ½ set bajtkÃ³dÅ¯. Jako prvnÃ­ vezmeme nÄ›co z tabulky literÃ¡lÅ¯ a vloÅ¾Ã­me to na stack.</p>
      <p id="51a18c4f-e58f-4f15-aa66-e2bceb523640" class="">Instrukce mÃ¡ dva parametry:</p>
      <ol id="51bababc-2e0a-40de-a83f-d5840f4c063c" class="numbered-list" start="1">
        <li><code>literal_type</code></li>
      </ol>
      <ol id="568c7bbb-81b8-43dc-b127-8c47be0efda0" class="numbered-list" start="2">
        <li><code>literal_index</code></li>
      </ol>
      <p id="abc270dd-b502-4a6f-8856-4169c85cec63" class="">DruhÃ½ urÄuje index v tabulce, prvnÃ­ pak typ literÃ¡lÅ¯, kterÃ½m v souÄasnosti mÅ¯Å¾ou bÃ½t:</p>
      <ol id="58d11351-a3d8-4f5f-8530-f0050c9d8d36" class="numbered-list" start="1">
        <li><code>Nil</code></li>
      </ol>
      <ol id="ce212102-644f-4d72-b0fb-c90bc6a40890" class="numbered-list" start="2">
        <li><code>Int</code></li>
      </ol>
      <ol id="5347fa9f-c398-4ff0-9983-db0e3d73d7a5" class="numbered-list" start="3">
        <li><code>String</code></li>
      </ol>
      <ol id="8bd3523a-b707-4c0a-90cf-98e042fbf41e" class="numbered-list" start="4">
        <li><code>Object</code></li>
      </ol>
      <ol id="2217cce4-0066-4ee4-a947-9066cfc0ba92" class="numbered-list" start="5">
        <li><code>Block</code></li>
      </ol>
      <ol id="65e505c8-8a79-4314-a374-24dfbe16dcd3" class="numbered-list" start="6">
        <li><code>Assignment primitive</code></li>
      </ol>
      <p id="24d93b7d-7929-46b9-8268-33b9b01fa7f1" class="">Detaily fungovÃ¡nÃ­ budou vysvÄ›tleny v kapitole o interpretru.</p>
      <p id="3b6c9efa-56a0-474e-9a8d-3c3ecedb97a5" class="">DÃ©lka instrukce: 3 bajtkÃ³dy.</p>
      <h3 id="fecdd51c-6a61-477c-a7e1-f4367739f6f0" class="">PUSH_SELF</h3>
      <p id="c3d85b40-3d5f-46ae-914b-39bb8ec2c024" class="">Na vrchol zÃ¡sobnÃ­ku vloÅ¾ <em>self</em>, tedy objekt v jehoÅ¾ kontextu aktuÃ¡lnÄ› probÃ­hÃ¡ kÃ³d.</p>
      <p id="d01f0f4f-d171-46b1-9ec1-d3c73806ae86" class="">DÃ©lka instrukce: 1 bajtkÃ³d.</p>
      <h3 id="db481803-3924-4d4f-9a53-ea4cd6395efe" class="">ADD_SLOT</h3>
      <p id="c9588a30-e0e8-4c50-8fa8-17fd6cd32c67" class="">Z vrcholu zÃ¡sobnÃ­ku seber jeden objekt jako <em>hodnotu</em>, druhÃ½ objekt jako <em>jmÃ©no</em> a tÅ™etÃ­ objekt jako <em>pÅ™Ã­jemce</em>. Do <em>pÅ™Ã­jemce</em> potom uloÅ¾ <em>hodnotu</em> na danÃ© <em>jmÃ©no</em>. VÃ½slednÃ½ objekt vloÅ¾ na vrchol zÃ¡sobnÃ­ku.</p>
      <p id="2c53be74-396b-4e3a-9acd-1f8a042fb9f6" class="">Tato instrukce by nemusela existovat, Å¡lo by to celÃ© implementovat pomocÃ­ <em>mirrorÅ¯</em>, ale vzhledem k tomu o jak Äasto pouÅ¾Ã­vanou zÃ¡leÅ¾itost se jednÃ¡, a jak straÅ¡nÄ› moc to zjednoduÅ¡uje zbytek kÃ³du, rozhodl jsem se jÃ­ takhle pouÅ¾Ã­t.</p>
      <p id="ca9e3e77-9c1c-4090-918a-699836ea3c3d" class="">DÃ©lka instrukce: 1 bajtkÃ³d.</p>
      <h3 id="11c286f6-775f-4319-a51f-539b5b45e874" class="">RETURN_TOP</h3>
      <p id="1b20df5e-7fc3-46b0-921a-a04c58b5fb5d" class="">Z vrcholu zÃ¡sobnÃ­ku vyber hodnotu a vraÅ¥ jÃ­.</p>
      <p id="d595646f-c88a-46a6-b3a9-85cdf1e69f15" class="">VrÃ¡cenÃ­ probÃ­hÃ¡ tak, Å¾e pokud jsou v tomto procesu pÅ™edchozÃ­ zÃ¡sobnÃ­ky, vloÅ¾ jÃ­ na vrchol pÅ™edchozÃ­ho zÃ¡sobnÃ­ku. Pokud ne, uloÅ¾ jÃ­ jako nÃ¡vratovou hodnotu procesu.</p>
      <p id="b4213605-e455-4295-8fe4-7ff496760a9f" class="">DÃ©lka instrukce: 1 bajtkÃ³d.</p>
      <h3 id="e3dfe0d6-82e9-4ed5-9705-223ca5e27572" class="">RETURN_IMPLICIT</h3>
      <p id="a0bef694-c7c6-4ab6-be34-987f497647cc" class="">Docela dlouho jsem pÅ™emÃ½Å¡lel k Äemu byla Pavlovi <code>returnImplicit</code>, a doÅ¡lo mi to aÅ¾ kdyÅ¾ jsem implementoval bloky.</p>
      <p id="be797d5b-14c7-4c35-844c-3bf372951309" class="">Z vrcholu zÃ¡sobnÃ­ku vyber hodnotu a vraÅ¥ jÃ­ skrz tolik framÅ¯, dokud nebudeÅ¡ ve scope ke kterÃ©mu se return vztahuje.</p>
      <p id="ff71dea5-2866-4961-bf88-8c06dace2569" class="">Tohle je SelfovÃ¡ specialita, kde return z bloku nevracÃ­ jen z bloku, ale ze scope, kde je blok pouÅ¾it.</p>
      <p id="5b84e2ef-ce31-4712-b8c1-a091fd47f828" class="">Tedy kÃ³d</p>
      <pre id="21d7025f-7afc-4403-8af4-c16a627b4ed8" class="code"><code>(|| something ifTrue: [^ something].)</code></pre>
      <p id="61f5e9d3-ccb4-44e0-a7c4-54557d84d504" class="">vracÃ­ nejen z bloku, ale i z method-objectu kolem nÄ›j.</p>
      <p id="743b39b5-0d7d-4dfa-9e99-a37db6bdffc9" class="">DÃ©lka instrukce 1 bajtkÃ³d.</p>
      <h3 id="5f50dff6-8ded-486a-abc0-e74582ba7f4d" class="">SEND</h3>
      <p id="56fb03c5-ead7-4bc8-92cd-28ee474d64cb" class="">NejkomplexnÄ›jÅ¡Ã­ instrukce, kterÃ¡ objektu na zÃ¡sobnÃ­ku poÅ¡le zprÃ¡vu.</p>
      <p id="502195f3-1aa7-428d-b555-90c210df1649" class="">Instrukce mÃ¡ dva parametry:</p>
      <ol id="232eb688-5acf-4393-8fc7-44852be87326" class="numbered-list" start="1">
        <li><code>message_type</code></li>
      </ol>
      <ol id="b980570c-a634-4fa3-845a-5addfe882dce" class="numbered-list" start="2">
        <li><code>number_of_parameters</code></li>
      </ol>
      <p id="5672677d-bb85-44bc-8fe1-ba60aac210c0" class="">Akt poslÃ¡nÃ­ zprÃ¡vy probÃ­hÃ¡ tak, Å¾e ze zÃ¡sobnÃ­ku je nejdÅ™Ã­ve vybrÃ¡no <code>number_of_parameters</code> objektÅ¯ do pole parametrÅ¯. V pÅ™Ã­padÄ›, Å¾e <code>message_type</code> je jeden z resend typÅ¯ (<code>UNARY_RESEND</code> Äi <code>KEYWORD_RESEND</code>, je navÃ­c jeÅ¡tÄ› z vrcholu zÃ¡sobnÃ­ku sebrÃ¡no jmÃ©no rodiÄe, kterÃ©mu se mÃ¡ zprÃ¡va pÅ™eposlat. DÃ¡le je z vrcholu zÃ¡sobnÃ­ku sebrÃ¡no jmÃ©no zprÃ¡vy (<em>selector</em>) a objekt, kterÃ©mu bude zprÃ¡va poslÃ¡na.</p>
      <p id="3ce88c31-1fc6-49dd-b6e2-238d477c93e6" class="">Pokud jde o resend, je zprÃ¡va pÅ™eposlÃ¡na parentovi - slot je vyhledÃ¡n v patÅ™iÄnÃ©m rodiÄovi a je vrÃ¡cen Äi vykonÃ¡n v souÄasnÃ©m kontextu.</p>
      <p id="3d882870-e034-4a76-8262-64801080b165" class="">Pokud jde o kÃ³d, je vykonÃ¡n tak, Å¾e je vytvoÅ™en novÃ½ zÃ¡sobnÃ­k, uloÅ¾en nulovÃ½ ukazatel na bajtkÃ³d (program counter) a objektu je pÅ™imapovÃ¡n do <code>.scope_parent</code> souÄasnÃ½ kontext.</p>
      <p id="62d40553-c87e-4c5b-aa35-7c084241f521" class="">Pokud jde o primitivnÃ­ kÃ³d, je vykonÃ¡n. PrimitivnÃ­ kÃ³d je volÃ¡nÃ­m kompilovanÃ½ch ÄÃ¡stÃ­ psanÃ½ch v RPythonu.</p>
      <p id="573bc941-07f7-432d-a095-3ff266742ae8" class="">Pokud jde o hodnotu, je vloÅ¾ena na vrchol zÃ¡sobnÃ­ku.</p>
      <p id="2aadc07c-70f5-4fd8-9fa0-1b072f72f9ae" class="">SEND je nejsloÅ¾itÄ›jÅ¡Ã­ instrukcÃ­, kterou moÅ¾nÃ¡ Äasem rozdÄ›lÃ­m na vÃ­c menÅ¡Ã­ch.</p>
      <p id="0ce63e96-91fe-4078-a9dd-9e83401fd0c0" class="">DÃ©lka instrukce: 3 bajtkÃ³dy.</p>
      <h3 id="85e77a44-9014-4da9-ae4c-a2571964ddd5" class="">BudoucÃ­ rozvoj</h3>
      <p id="0b4b56b9-15cb-40e2-b585-cc46c6f6d423" class="">BajtkÃ³d, anglicky <em>bytecode</em>, je od slova <em>byte</em>. SamozÅ™ejmÄ› nemusÃ­ mÃ­t pÅ™esnÄ› jeden bajt, ostatnÄ› moje instrukÄnÃ­ sada by se mohla vejÃ­t do ÄtyÅ™ bitÅ¯. Do budoucna by ale mohlo interpreter zrychlit, kdybych provedl rozvoj vÅ¡ech Äasto pouÅ¾Ã­vanÃ½ch instrukcÃ­ a pÅ™evedl je z nÄ›kolika-bajtovÃ½ch parametrizovanÃ½ch na jedno-bajtovovÃ©. NapÅ™Ã­klad bych mohl zavÃ©st bajtkÃ³d pro <code>SELF_SEND</code>, kterÃ½ by zkombinoval funkcionalitu <code>PUSH_SELF</code> a <code>SEND</code>. Nebo <code>SENDKW1</code>, kterÃ½ automaticky vybere jeden parametr ze zÃ¡sobnÃ­ku a bere ho jako <em>keyword message</em>. NÄ›kterÃ© instrukce by mohly obchÃ¡zet <code>PUSH_LITERAL</code> bajtkÃ³d a rovnou si sahat na index do tabulky literÃ¡lÅ¯. A tak podobnÄ›.</p>
      <p id="6893f76e-0da1-41af-b436-0b93131d54a4" class="">Taky limitace parametrÅ¯ na jeden bajtkÃ³d momentÃ¡lnÄ› znamenÃ¡, Å¾e je moÅ¾nÃ© pouÅ¾Ã­t pouze 256 literÃ¡lÅ¯ v jednÃ© metodÄ›, coÅ¾ ovÅ¡em v souÄasnÃ© fÃ¡zi vÃ½voje bohatÄ› staÄÃ­ a nemÃ¡ smysl to Å™eÅ¡it. ÄŒasem chci pÅ™idat rozvoj na minimÃ¡lnÄ› dvoubajtovÃ© definice, takÅ¾e PUSH_LITERAL se prodlouÅ¾Ã­.</p>
      <p id="ea92bdf0-030f-4abc-936f-d6e183debd02" class="">ZatÃ­m se vÅ¡ak budu drÅ¾et souÄasnÃ© podoby, jelikoÅ¾ mÃ¡m vÄ›tÅ¡Ã­ problÃ©my k vyÅ™eÅ¡enÃ­ a jak pravil klasik, pÅ™edÄasnÃ¡ optimalizace je koÅ™enem vÅ¡eho zla.</p>
      <h2 id="45861fe8-3040-4c76-a160-68451dc5e08b" class="">CodeContext</h2>
      <p id="a2e8f760-4642-44d0-8319-e00e97d536eb" class="">StojÃ­ za zmÃ­nku se podÃ­vat, v Äem a jak jsou vlastnÄ› bajtkÃ³dy i literÃ¡ly uklÃ¡dÃ¡ny. JednÃ¡ se o tÅ™Ã­du <code>CodeContext</code>, kterÃ¡ obsahuje string s bajtkÃ³dy. Å˜eÅ¡il jsem na <code>#pypy</code> v Äem je nejlepÅ¡Ã­ uchovÃ¡vat bajtkÃ³dy, protoÅ¾e sÃ¡m bych mÄ›l asi tendence pouÅ¾Ã­t <code>bytearray</code>, ale ten jednak po RPythonem funguje divnÄ› (mÄ›l jsem s tÃ­m nÄ›jakÃ© problÃ©my, uÅ¾ nevÃ­m pÅ™esnÄ› jakÃ©), ale hlavnÄ› je pomalejÅ¡Ã­ neÅ¾ zpracovÃ¡nÃ­ stringÅ¯.</p>
      <p id="2249bb00-2c89-4516-acdb-a23aec802c26" class="">DÃ¡le obsahuje pole <code>literals</code> s tabulkou literÃ¡lÅ¯, z nihÅ¾ kaÅ¾dÃ½ je zabalen v nÄ›jakÃ©m boxu (viz omezenÃ­ RPythonu na jeden datovÃ½ typ polÃ­).</p>
      <figure id="b7f38b21-909a-42d2-baa0-c0c9bac48ca7" class="image">
        <a href="code_context.png" title="code_context.png"><img style="width:731px" src="code_context.png"></a>
      </figure>
      <p id="fbcf2328-ead6-45d0-814b-ba232756e3ec" class="">Pak jsou zde jeÅ¡tÄ› doÄasnÄ› uloÅ¾eny rÅ¯znÃ© speciÃ¡lnÃ­ hodnoty, napÅ™Ã­klad se tu keÅ¡ujÃ­ doÄasnÃ© mezi-objekty, kterÃ© uchovÃ¡vajÃ­ parametry.</p>
      <h2 id="3c2092a7-db20-4121-a54b-269e934ef566" class="">ZÃ¡sobnÃ­ky</h2>
      <p id="af2abb54-1d86-4fcd-940e-cfa7a9757d09" class="">ZasobnÃ­ky jsem implementoval jako hierarchickou strukturu tÅ™Ã­ tÅ™Ã­d;</p>
      <figure id="a282e57a-ba3c-470d-b960-bb0636e5e0cb" class="image">
        <a href="frames.png" title="frames.png"><img style="width:896px" src="frames.png"></a>
      </figure>
      <h3 id="753ea828-bbfa-4567-8272-3584596925bc" class="">MethodStack</h3>
      <p id="27102a6b-4b17-4871-9414-1527a929f4d8" class="">TÅ™Ã­da <code>MethodStack</code> tvoÅ™Ã­ prostÃ½ zÃ¡sobnÃ­k, na jehoÅ¾ vrchol je moÅ¾nÃ© vloÅ¾it instanci <code>Objekt</code>u metodou <code>.push()</code>, sundat z vrcholu <code>Objekt</code> metodou <code>.pop()</code> a jako bonus implementuje <code>.pop_or_nil()</code>, kterÃ¡ v pÅ™Ã­padÄ› Å¾e je zÃ¡sobnÃ­k prÃ¡zdnÃ½ vrÃ¡tÃ­ singleton <code>Objekt</code>u <code>nil</code>.</p>
      <p id="de3a54e6-88ef-4184-aba5-12d7fa94d433" class="">TÅ™Ã­da dÃ¡le uchovÃ¡vÃ¡ nÄ›jakÃ© obecnÃ© properties, jako <code>.error_handler</code>, <code>.code_context</code>, <code>.bc_index</code> a <code>.self</code>. Error handler je pouÅ¾it k Å™eÅ¡enÃ­ vÃ½jimek, code_context uchovÃ¡vÃ¡ bajtkÃ³dy a bc_index slouÅ¾Ã­ jako program counter.</p>
      <p id="586293c9-3b3f-48d5-8e42-502936f541f3" class="">PÅ™i bÄ›hu metody se sem uklÃ¡dajÃ­ jednotlivÃ© literÃ¡ly a postupnÄ› si je z toho tahajÃ­ instrukce tak jak jdou za sebou. V pÅ™Ã­padÄ› Å¾e je volÃ¡na dalÅ¡Ã­ metoda, tak na vrchol zÃ¡sobnÃ­ku se vloÅ¾Ã­ vÃ½sledek potÃ© co skonÄÃ­. To Å™eÅ¡Ã­ nÃ¡sledujÃ­cÃ­ tÅ™Ã­da metodou <code>.pop_frame_down()</code>.</p>
      <p id="72bf6868-e672-4aab-8c31-befcd8396ed1" class="">MomentÃ¡lnÄ› jsou k dispozici dvÄ› implementace, jedna jako pÅ™ed-alokovanÃ© pole, kterÃ¡ je trochu rychlejÅ¡Ã­ v kÃ³du bez JITu a druhÃ¡ jako linked-list, kterÃ¡ je trochu rychlejÅ¡Ã­ s JITem.</p>
      <h3 id="dbb6a3f8-a4e5-4db2-9790-9e18509f6984" class="">ProcessStack</h3>
      <p id="b169d068-4ea8-4ac5-8058-934a19a31fb6" class="">Na tuto tÅ™Ã­du navazuje <code>ProcessStack</code>, kterÃ½ je zÃ¡sobnÃ­kem zÃ¡sobnÃ­kÅ¯ a v podstatÄ› reprezentuje jeden bÄ›Å¾Ã­cÃ­ proces. PokaÅ¾dÃ©, kdyÅ¾ je vykonÃ¡vÃ¡n nÄ›jakÃ½ <code>Object</code> s kÃ³dem, je v nÃ­ vytvoÅ™en novÃ½ zÃ¡sobnÃ­k. KdyÅ¾ kÃ³d dobÄ›hne, tak vezme poslednÃ­ hodnotu z poslednÃ­ho zÃ¡sobnÃ­ku a vloÅ¾Ã­ jÃ­ na vrchol zÃ¡sobnÃ­ku pÅ™edtÃ­m. Ten co je na vrchu pak zahodÃ­ (proto nejsou potÅ™eba samostatnÃ© <code>POP</code> bajtkÃ³dy).</p>
      <p id="74b0e0af-62a1-45df-945e-d47364281ba6" class="">Jak uÅ¾ napovÃ­dÃ¡ nÃ¡zev, taky uchovÃ¡vÃ¡ dalÅ¡Ã­ kontext â€procesuâ€œ, jako vÃ½sledek bÄ›hu programu, informaci o tom jestli proces jeÅ¡tÄ› stÃ¡le bÄ›Å¾Ã­, nebo ne.</p>
      <p id="4ead4811-527b-440e-a4db-1d4f97e30f11" class="">Za zmÃ­nku stojÃ­, Å¾e aktuÃ¡lnÃ­ frame navrchu je vÅ¾dy uchovÃ¡vÃ¡n v promÄ›nnÃ© <code>.frame</code>.</p>
      <h3 id="81dc8e65-3489-4eb1-9984-ae2867cb962c" class="">ProcessCycler</h3>
      <p id="093c2cde-7d5c-40db-a536-a229c44c51d9" class="">PoslednÃ­ tÅ™Ã­dou je <code>ProcessCycler</code>, kterÃ½ pÅ™epÃ­nÃ¡ aktuÃ¡lnÄ› provÃ¡dÄ›nÃ½ proces tÃ­m, Å¾e ho vÅ¾dy uloÅ¾Ã­ do promÄ›nnÃ© <code>.process</code>. Vzhledem k tomu, Å¾e smyÄka interpreteru vÅ¾dy naÄte tuto hodnotu, provede jeden bajtkÃ³d a zavolÃ¡ cyklovÃ¡nÃ­ procesu, je tÃ­m docÃ­leno jednoduchÃ© paralelizace.</p>
      <h2 id="d256e27a-0c70-4bba-98be-e153730fb1ef" class="">PokraÄovÃ¡nÃ­</h2>
      <p id="616977c8-4cf7-4fb2-8fe6-ce889940f7ed" class="">V dalÅ¡Ã­m dÃ­le se podÃ­vÃ¡me na implementace kompilÃ¡toru do vÃ½Å¡e uvedenÃ©ho bajtkÃ³du. AÄkoliv jsem intuitivnÄ› Äekal, Å¾e pÅ¯jde o nÄ›co sloÅ¾itÃ©ho, nakonec se to ukÃ¡zalo jako jedna z nejjednoduÅ¡Å¡Ã­ch vÄ›cÃ­ na celÃ©m projektu.</p>
      <h2 id="7591ff77-2b88-4a4d-ac8d-e8c1f4b8c73d" class="">RelevantnÃ­ diskuze</h2>
      <ul id="383f49a2-8e01-435f-982c-cf89f0c6ea5d" class="bulleted-list">
        <li>
          <a href="http://www.abclinuxu.cz/blog/bystroushaak/2019/4/jak-se-pise-programovaci-jazyk-5-bajtkod-a-literaly">Jak se pÃ­Å¡e programovacÃ­ jazyk 5: BajtkÃ³d a literÃ¡ly</a> (abclinuxu)
        </li>
      </ul>
    </div>
  </article>
  <div class="corner-ribbon top-right red">
    <a href="https://www.patreon.com/bePatron?u=2618881">Become a Patron</a>
  </div><a class="twitter-share-button" id="twitter_button" href="#"><img src="../../../../tweet_button.svg"></a>
  <div id="sidebar_bottom">
    <span><a href="https://blog.rfox.eu/atom.xml"><img style="width: 3em;" src="../../../../rss_icon.png"></a> &nbsp; &nbsp; <a href="https://twitter.com/Bystroushaak"><img style="width: 3em;" src="../../../../twitter_icon.png"></a></span>
    <div id="last_five_bottom">
      <h3>New posts</h3>
      <ul>
        <li>
          <a href="../../../Predstaveni/GPT-3.html" title="GPT-3">GPT-3</a>
        </li>
        <li>
          <a href="https://blog.rfox.eu/atom_cz.xml">VytvoÅ™en novÃ½ Atom (RSS) feed pro Äeskou sekci</a>
        </li>
      </ul>
    </div>
    <div>
      <h3>Blog categories</h3>
      <ul class="no_icon">
        <li>
          <a href="../../../Programovani.html" title="ProgramovÃ¡nÃ­">ğŸ“‚ ProgramovÃ¡nÃ­</a>
        </li>
        <li>
          <a href="../../../Knihy.html" title="Knihy">ğŸ“‚ Knihy</a>
        </li>
        <li>
          <a href="../../../Predstaveni.html" title="PÅ™edstavenÃ­">ğŸ“‚ PÅ™edstavenÃ­</a>
        </li>
        <li>
          <a href="../../../Povidky.html" title="PovÃ­dky">ğŸ“‚ PovÃ­dky</a>
        </li>
        <li>
          <a href="../../../Hrbitov.html" title="HÅ™bitov">ğŸ“‚ HÅ™bitov</a>
        </li>
        <li>
          <a href="../../../Ostatni.html" title="OstatnÃ­">ğŸ“‚ OstatnÃ­</a>
        </li>
        <li>
          <a href="../../../Abclinuxu.html" title="Abclinuxu">ğŸ“‚ Abclinuxu</a>
        </li>
        <li>
          <a href="../../../index.html" title="Czech section">ğŸ“‚ Czech section</a>
        </li>
      </ul>
    </div>
  </div>
</body>
</html>
