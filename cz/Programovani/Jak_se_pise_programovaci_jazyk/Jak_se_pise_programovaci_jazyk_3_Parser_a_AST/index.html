<!DOCTYPE html>
<html>
<head>
  <meta name="generator" content="HTML Tidy for HTML5 for Linux version 5.2.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Jak se p√≠≈°e programovac√≠ jazyk 3: Parser a AST</title>
  <link rel="stylesheet" type="text/css" href="../../../../style.css">
  <link rel="alternate" type="application/atom+xml" href="http://blog.rfox.eu/atom_cz.xml">
  <link rel="shortcut icon" href="/favicon.ico">
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@Bystroushaak">
  <meta name="twitter:creator" content="@Bystroushaak">
  <meta name="twitter:title" content="Jak se p√≠≈°e programovac√≠ jazyk 3: Parser a AST">
  <meta name="twitter:description" content="Ve t≈ôet√≠m d√≠lu seri√°lu Jak se p√≠≈°e programovac√≠ jazyk se pod√≠v√°me na zp≈Øsob, kter√Ωm se z jednorozmƒõrn√©ho pole Token objekt≈Ø udƒõl√° syntaktick√Ω strom, kter√Ω pak n√°slednƒõ m≈Ø≈æeme d√°le zpracov√°vat a vyhodnocovat.">
  <meta name="twitter:image" content="http://blog.rfox.eu/cz/Programovani/Jak_se_pise_programovaci_jazyk/Jak_se_pise_programovaci_jazyk_3_Parser_a_AST/ast_thumb.jpg">
  <script src="../../../../scripts.js">
  </script>
  <meta name="description" content="Ve t≈ôet√≠m d√≠lu seri√°lu Jak se p√≠≈°e programovac√≠ jazyk se pod√≠v√°me na zp≈Øsob, kter√Ωm se z jednorozmƒõrn√©ho pole Token objekt≈Ø udƒõl√° syntaktick√Ω strom, kter√Ω pak n√°slednƒõ m≈Ø≈æeme d√°le zpracov√°vat a vyhodnocovat."><!-- Global site tag (gtag.js) - Google Analytics -->

  <script src="https://www.googletagmanager.com/gtag/js?id=UA-142545439-1">
  </script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-142545439-1');
  </script>
  <script data-ad-client="ca-pub-8322439660353685" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async>
  </script>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.css">
</head>
<body onload="on_body_load();">
  <div id="sidebar_top">
    <div id="last_five_top">
      <h3>New posts:</h3>
      <ul>
        <li>
          <a href="https://blog.rfox.eu/atom_cz.xml">Vytvo≈ôen nov√Ω Atom (RSS) feed pro ƒçeskou sekci</a>
        </li>
      </ul>
    </div>
    <div>
      <h3>Blog categories:</h3>
      <ul class="no_icon">
        <li>
          <a href="../../../Programovani.html" title="Programov√°n√≠">üìÇ Programov√°n√≠</a>
        </li>
        <li>
          <a href="../../../Povidky.html" title="Pov√≠dky">üìÇ Pov√≠dky</a>
        </li>
        <li>
          <a href="../../../Knihy.html" title="Knihy">üìÇ Knihy</a>
        </li>
        <li>
          <a href="../../../Predstaveni.html" title="P≈ôedstaven√≠">üìÇ P≈ôedstaven√≠</a>
        </li>
        <li>
          <a href="../../../Ostatni.html" title="Ostatn√≠">üìÇ Ostatn√≠</a>
        </li>
        <li>
          <a href="../../../Abclinuxu.html" title="Abclinuxu">üìÇ Abclinuxu</a>
        </li>
        <li>
          <a href="../../../Hrbitov.html" title="H≈ôbitov">üìÇ H≈ôbitov</a>
        </li>
        <li>
          <a href="../../../index.html" title="Czech section">üìÇ Czech section</a>
        </li>
      </ul>
    </div><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8322439660353685" data-ad-slot="8589969791" data-ad-format="auto" data-full-width-responsive="true"></ins> 
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
  </div><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8322439660353685" data-ad-slot="9175281399" data-ad-format="auto" data-full-width-responsive="true"></ins> 
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script> <a class="breadcrumb" href="../../../../index.html" title="Bystroushaak's blog">Bystroushaak's blog</a> / <a class="breadcrumb" href="../../../index.html" title="Czech section">Czech section</a> / <a class="breadcrumb" href="../../index.html" title="Programov√°n√≠">Programov√°n√≠</a> / <a class="breadcrumb" href="../index.html" title="Jak se p√≠≈°e programovac√≠ jazyk">Jak se p√≠≈°e programovac√≠ jazyk</a> / Jak se p√≠≈°e programovac√≠ jazyk 3: Parser a AST
  <article id="be275547-b187-4543-b222-57949fac8c51" class="page sans">
    <header>
      <h1 class="page-title">Jak se p√≠≈°e programovac√≠ jazyk 3: Parser a AST</h1>
    </header>
    <div class="page-body">
      <p id="d22624d8-9c4b-4813-acee-87e959dd9f4e" class=""><time>@2019/02/16</time></p>
      <p id="7972e399-39dc-4cc4-9fac-14c6d44dc154" class="">Ve t≈ôet√≠m d√≠lu seri√°lu <em>Jak se p√≠≈°e programovac√≠ jazyk</em> se pod√≠v√°me na zp≈Øsob, kter√Ωm se z jednorozmƒõrn√©ho pole <code>Token</code> objekt≈Ø udƒõl√° syntaktick√Ω strom, kter√Ω pak n√°slednƒõ m≈Ø≈æeme d√°le zpracov√°vat a vyhodnocovat.</p>
      <h1 id="3d9a6798-79b3-47f1-82bc-8d407702a16a" class="">Parser</h1>
      <p id="69f234e5-edcc-44bd-bac0-fcd319e19d42" class="">Jak bylo pops√°no v minul√©m d√≠lu, Lexer v√°m k√≥d roz≈ôe≈æe na pole jednotliv√Ωch element≈Ø. V m√©m p≈ô√≠padƒõ z k√≥du jako:</p>
      <pre id="c54fe7eb-4c72-43d1-afc3-e9eb6170cdd4" class="code"><code>(| asd = 1 | ^asd.)</code></pre>
      <p id="cefcc4f1-2ab2-4a17-9431-d08381303c88" class="">udƒõl√° pole ve stylu:</p>
      <pre id="628aa0af-6c21-477b-b432-a154b1f70fa7" class="code"><code>[
  Token("OBJ_START", "("),
  Token("SEPARATOR", "|"),
  Token("IDENTIFIER", "asd"),
  Token("ASSIGNMENT", "="),
  Token("NUMBER", "1"),
  Token("SEPARATOR", "|"),
  Token("RETURN", "^"),
  Token("IDENTIFIER", "asd"),
  Token("OBJ_END", ")")
]</code></pre>
      <p id="79e40b53-cb13-44d6-a62f-1ef78abdf620" class="">Jde o seznam <a href="https://github.com/solanolabs/rply/blob/master/rply/token.py">Token</a> objekt≈Ø, kde v property <code>.name</code> je ulo≈æen n√°zev tokenu (nap≈ô√≠klad <em>‚ÄûIDENTIFIER‚Äú</em>) a v <code>.value</code> jeho hodnota (nap≈ô√≠klad <em>‚Äûasd‚Äú</em>). Na parseru je pot√© k√≥d vz√≠t a udƒõlat z nƒõj AST (abstraktn√≠ syntaktick√Ω strom) ve stylu:</p>
      <pre id="c4f4910a-e300-4a5b-867f-014d6489a3e2" class="code"><code>Object(
  slots={"asd": Number(1)},
  params=[],
  parents={},
  code=[
    Return(
      Send(Self(), Message("asd"))
    )
  ],
)</code></pre>
      <p id="d28f5ee0-fe48-47b7-99de-d0c973ef9142" class="">Na to jak je tinySelf jednoduch√Ω jazyk mi dal parser docela zabrat. P≈Øvodnƒõ jsem ho zaƒçal ps√°t v RPythonn√≠m <a href="http://rpython.readthedocs.io/en/latest/rlib.html#ebnf">rpython.rlib.parsing.ebnfparse</a>, co≈æ vypadalo opticky dob≈ôe a jednodu≈°e:</p>
      <pre id="ed29d4b7-34ce-4cad-b7ee-5a926fc227d8" class="code"><code>IGNORE: " |\n";

root: (expression ["\."])* expression;

object: ["("] slots? sends* [")"];
block: ["["] slots? sends* ["]"];

return: ["^"] expression;
expression: IDENTIFIER | value | object | block | send;

#sends: (send ["\."])* send ["\."]?;
sends: (expression ["\."])* expression ["\."]?;
send: (receiver? keyword) | (receiver? message) | (receiver? receiver? operator receiver);
receiver: IDENTIFIER | object | block;
message: IDENTIFIER;
keyword: FIRST_KW_IDENTIFIER &gt;expression&lt; (KEYWORD_IDENTIFIER &gt;expression&lt;)*;
operator: operator_characters+;
operator_characters: "!" | "@" | "#" | "$" | "%" | "&amp;" | "*" | "-" | "+" | \
                     "=" | "~" | "/" | "?" | "&lt;" | "&gt;" | "," | ";";

slots: ["|"] (&gt;slot_definition&lt; ["\."])* &gt;slot_definition&lt;? ["\."]? ["|"];
slot_definition: IDENTIFIER | (FIRST_KW_IDENTIFIER &gt;expression&lt;) | ARGUMENT;

value: &lt;string&gt; | &lt;float&gt; | &lt;integer&gt;;

float: integer "\." POSINT;
integer: "\-" POSINT | POSINT;

POSINT: "0|[1-9][0-9]*";

ARGUMENT: ":[a-z_][a-zA-Z0-9_\*]*";
IDENTIFIER: "[a-z_][a-zA-Z0-9_\*]*";
FIRST_KW_IDENTIFIER: "[a-z_][a-zA-Z0-9_]*:";
KEYWORD_IDENTIFIER: "[A-Z][a-zA-Z0-9_]*:";

string: SINGLE_QUOTED_STRING | DOUBLE_QUOTED_STRING;
SINGLE_QUOTED_STRING: "'[^\\\']*'";
DOUBLE_QUOTED_STRING: "\\"[^\\\\"]*\\"";</code></pre>
      <p id="9322bf60-afd6-4920-b4ba-2193f37df136" class="">Pomƒõrnƒõ z√°hy jsem v≈°ak narazil na nedostatek dokumentace a taky na chov√°n√≠, kter√© mi vyslovenƒõ vadilo (v≈°echny ty <code>&gt;&lt;</code> a <code>&lt;&gt;</code> kolem identifik√°tor≈Ø, divn√° rekurze s <code>|</code>, mixov√°n√≠ s regul√°ry atd..). Od zaƒç√°tku jsem to pojal jako TDD development (psatn√≠ test≈Ø p≈ôed k√≥dem) a jen d√≠ky tomu jsem se z toho nezcvokl, nemƒõl jsem k tomu v≈°ak daleko.</p>
      <p id="6dc80472-9047-4907-a95a-575736074d5d" class="">Byst≈ôej≈°√≠ ƒçten√°≈ôi si jistƒõ v≈°imli, ≈æe v k√≥du jsou pou≈æity jin√© tokeny, ne≈æ v p≈ôedchoz√≠m d√≠le. Je tomu tak proto, ≈æe <code>ebnfparse</code> umo≈æ≈àuje definovat tokeny z√°rove≈à s parserem, co≈æ <a href="https://rply.readthedocs.io/">rply</a> neumo≈æ≈àuje a to co bylo uvedeno v minul√©m d√≠le je m√° pozdƒõj≈°√≠ snaha.</p>
      <h1 id="5b183968-a7db-4ca4-90dd-9c087af6e2fb" class="">RPLY</h1>
      <p id="66f9efe0-7194-43a5-8461-e7b99a089d2a" class="">Chybƒõj√≠c√≠ dokumentace mƒõ ƒçasem donutila od RPythonn√≠ho <code>ebnfparse</code> odej√≠t, speci√°lnƒõ kdy≈æ jsem si proch√°zel ostatn√≠ projekty, kter√© pou≈æ√≠valy jin√© parsery. ƒåasem jsem narazil na <a href="https://rply.readthedocs.io/en/latest/">rply</a>, co≈æ je port parseru <a href="https://github.com/dabeaz/ply">ply</a> p≈ô√≠mo pro RPython. Funguje tak, ≈æe p√≠≈°ete dekor√°tory funkc√≠m ve stylu:</p>
      <pre id="5cd6046e-24b6-46cc-a94b-4401ac9b4c3c" class="code"><code>@pg.production('expression : NUMBER')
def expression_number(p):
    return Number(int(p[0].getstr()))</code></pre>
      <p id="c3f50bb6-685a-4558-8c41-2c15b12995cb" class="">Dekor√°tor urƒçuje pattern z token≈Ø. Dekorovan√° funkce pak co se s tokeny provede. V≈°echny tokeny jsou p≈ôed√°ny v poli v promƒõnn√© ‚Äö<code>p</code>‚Äò.</p>
      <p id="99d8df1e-28df-45bb-a8bb-05d18fed3a4f" class="">V k√≥du naho≈ôe se vezme prvn√≠ token (index 0) a vrat√≠ se objekt <code>Number</code> s tokenem, jeho≈æ hodnota byla p≈ôevedena na ƒç√≠slo.</p>
      <p id="b023c94a-28a4-4dd4-9ec9-64698c694dda" class="">Number nen√≠ ≈æ√°dn√Ω magick√Ω objekt, nadefinoval jsem si ho s√°m po vzoru ostatn√≠ch parser≈Ø. Dohromady m√°m tyto objekty, ze kter√Ωch se sestavuje syntaktick√Ω strom:</p>
      <figure id="15baed76-e73a-4d6f-8812-d0251999d793" class="image">
        <a href="ast.png" title="ast.png"><img style="width:1960px" src="ast_thumb.jpg"></a>
      </figure>
      <p id="4292bd03-b4a0-4e27-83f3-f6761e59e97e" class="">Jak je vidƒõt, v tinySelfu existuj√≠ pouze objekty, bloky, akt posl√°n√≠ zpr√°vy, p≈ôeposl√°n√≠ zpr√°vy, kask√°da zpr√°v (akt posl√°n√≠ nƒõkolika zpr√°v jednomu objektu), n√°vrat hodnoty, t≈ôi typy zpr√°v (un√°rn√≠, bin√°rn√≠, <em>keyword</em>) a pot√© ƒçty≈ôi zkratky pro ƒçasto pou≈æ√≠van√© objekty: ƒç√≠sla, stringy, Self a Nil. Self by existovat teoreticky nemusel, mohla by to b√Ωt jen <code>Message("self")</code> poslan√° nikomu, ale zp≈ôehled≈àuje to k√≥d i v√Ωsledn√Ω strom. Nil je jen zkratka pro singleton, kter√Ω by mohl b√Ωt ulo≈æen√Ω v glob√°ln√≠m namespace.</p>
      <h2 id="56745c3a-7c85-4b59-b961-b642b26b0bb7" class="">Slo≈æitƒõj≈°√≠ rekurzivn√≠ pravidla</h2>
      <p id="8ae1b03b-3492-4bb2-863a-3d287d777fdf" class="">Zde je uk√°zka slo≈æitƒõj≈°√≠ho transformaƒçn√≠ho pravidla:</p>
      <pre id="33016725-4452-4628-ba91-fe46da2bce8e" class="code"><code>@pg.production('expression : IDENTIFIER')
def unary_message(p):
    return Send(obj=Self(), msg=Message(p[0].getstr()))

@pg.production('expression : expression IDENTIFIER')
def unary_message_to_expression(p):
    return Send(obj=p[0], msg=Message(p[1].getstr()))</code></pre>
      <p id="2ad85d1c-f521-487d-be72-4fc4441175a0" class="">Na uk√°zce je dob≈ôe vidƒõt, jak vznik√° posl√°n√≠ zpr√°v a jak je ≈ôe≈°eno vkl√°d√°n√≠ implicitn√≠ho Selfu. Pokud je identifik√°tor posl√°n zd√°nlivƒõ niƒçemu, je aktu posl√°n√≠ zpr√°vy p≈ôed√°n jako c√≠l <code>Self()</code>. Pokud je p≈ôed identifik√°torem nƒõjak√Ω v√Ωraz, je c√≠li posl√°n√≠ zpr√°vy p≈ôed√°n prvn√≠ token obsahuj√≠c√≠ tento v√Ωraz (co≈æ u≈æ je naparsovan√° expression, tedy prvek AST).</p>
      <p id="9a6187a5-0701-48b1-9caf-7b8fc9663191" class="">Podobn√Ωmi pravidly je slo≈æen cel√Ω jazyk. Zde je tak√© hezky vidƒõt rekurzivn√≠ povaha parseru, kter√Ω definuje <em>expression</em> jako identifik√°tor a pot√© tak√© jako <em>expression</em> n√°sledovan√© identifik√°torem. Parser takhle provede rekurzivn√≠ <em>pattern matching</em> na v≈°echny odpov√≠daj√≠c√≠ tokeny, v samotn√Ωch funkc√≠ch se pak jen definuje, co se z toho m√° slo≈æit za AST.</p>
      <p id="c5093b42-f0b8-4c02-8abd-46e80c632d8c" class="">Tenhle p≈ô√≠stup m√° svou v√Ωhodu, proto≈æe v√°m dovoluje skl√°dat AST p≈ô√≠mo tak jak ho chcete. P≈ôedt√≠m pou≈æ√≠van√Ω <code>ebnf</code> z RPythonu vypadal sice zaps√°n elegantnƒõji jako jeden kr√°sn√Ω string, ale neumo≈æ≈àoval ≈æ√°dn√© skoro ≈æ√°dn√© manipupace s AST a vyplivl v√°m strom z token≈Ø, kter√Ω bylo d√°le t≈ôeba zpracov√°vat. I kdy≈æ to bylo na vy≈°≈°√≠ √∫rovni, ne≈æ samotn√© pole token≈Ø, stejnƒõ to byl masivn√≠ opruz. Oproti tomu p≈ô√≠m√Ω p≈ô√≠stup k dat≈Øm v rply v√°m umo≈æ≈àuje vygenerovat rovnou hotov√Ω a upraven√Ω AST.</p>
      <p id="0f5a2869-8095-456c-b00e-f2e95bc420b1" class="">Zde je zdrojov√Ω k√≥d cel√©ho parseru:</p>
      <ul id="3df38aab-0234-40e2-83dd-4259b972c50f" class="bulleted-list">
        <li>
          <a href="https://github.com/Bystroushaak/tinySelf/blob/master/src/tinySelf/parser/parser.py">parser.py</a>
        </li>
      </ul>
      <p id="2346a27c-f941-4a2c-b701-7915156e927c" class="">Nikdy d≈ô√≠v jsem nepsal takhle slo≈æit√Ω EBNF parser a mus√≠m ≈ô√≠ct, ≈æe to pro mƒõ byl docela z√°hul. Nauƒçit se p≈ôem√Ω≈°let v rekurzivnƒõ skl√°dan√Ωch definic√≠ch mi dalo zabrat, a to ani nemluv√≠m o tom, ≈æe jsem pro Self nena≈°el ≈æ√°dnou EBNF definici, tak≈æe jsem si j√≠ podle manu√°lu +- skl√°dal s√°m.</p>
      <figure id="6dea40d6-e3c2-49da-9866-8a3729309f04" class="image">
        <a href="passing_tests.png" title="passing_tests.png"><img style="width:890px" src="passing_tests.png"></a>
      </figure>
      <p id="7825c40c-7620-4ffd-9ff1-c1b3595113b6" class="">Nakonec se v≈°ak povedlo a k√≥d pro≈°el v≈°emi testy, kter√© jsem pro nƒõj napsal. Myslel jsem si, ≈æe t√≠m to pro mƒõ konƒç√≠, ale jak se uk√°zalo, byl to jen zaƒç√°tek dal≈°√≠ parsovac√≠ bolesti, tentokr√°t spoƒç√≠vaj√≠c√≠ ve snaze k√≥d upravit pro p≈ôeklad RPythonem.</p>
      <h1 id="76735348-6d36-43bf-9c29-9709bf25382c" class="">Pokraƒçov√°n√≠</h1>
      <p id="4c34c5cf-c9ee-41e9-9f37-d2c77dea713f" class="">P≈ô√≠≈°t√≠ d√≠l bude takov√Ωm mezid√≠lem na t√©ma RPythonu a nƒõkter√Ωch praktick√Ωch probl√©m≈Ø, kter√© jsem musel vy≈ôe≈°it, abych mohl parser a lexer pod n√≠m zkompilovat.</p>
      <h1 id="035572b4-371d-4d89-8cd2-3c89557492b1" class="">Relevantn√≠ diskuze</h1>
      <ul id="252d60a9-acd8-4e03-97ff-967994b7d34a" class="bulleted-list">
        <li>
          <a href="http://www.abclinuxu.cz/blog/bystroushaak/2019/2/jak-se-pise-programovaci-jazyk-3-parser-a-ast">Jak se p√≠≈°e programovac√≠ jazyk 3: Parser a AST</a> (abclinuxu)
        </li>
      </ul>
      <p id="04abc208-70cd-4bf0-9fce-e3d64cdf46c4" class=""></p>
    </div>
  </article>
  <div class="corner-ribbon top-right red">
    <a href="https://www.patreon.com/bePatron?u=2618881">Become a Patron</a>
  </div><a class="twitter-share-button" id="twitter_button" href="#"><img src="../../../../tweet_button.svg"></a> <ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8322439660353685" data-ad-slot="4657737295" data-ad-format="auto" data-full-width-responsive="true"></ins> 
  <script>
  (adsbygoogle = window.adsbygoogle || []).push({});
  </script> 
  <script src="https://cdn.jsdelivr.net/npm/cookieconsent@3/build/cookieconsent.min.js" data-cfasync="false">
  </script> 
  <script>
  window.cookieconsent.initialise({
  "palette": {
    "popup": {
      "background": "#edeff5",
      "text": "#838391"
    },
    "button": {
      "background": "#4b81e8"
    }
  }
  });
  </script>
  <div id="sidebar_bottom">
    <div id="last_five_bottom">
      <h3>New posts:</h3>
      <ul>
        <li>
          <a href="https://blog.rfox.eu/atom_cz.xml">Vytvo≈ôen nov√Ω Atom (RSS) feed pro ƒçeskou sekci</a>
        </li>
      </ul>
    </div>
  </div>
</body>
</html>
