<!DOCTYPE html>
<html>
<head>
  <meta name="generator" content="HTML Tidy for HTML5 for Linux version 5.2.0">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>Jak se p√≠≈°e programovac√≠ jazyk 3.5: RPython</title>
  <link rel="stylesheet" type="text/css" href="../../style.css">
  <link rel="alternate" type="application/atom+xml" href="http://blog.rfox.eu/atom.xml">
  <link rel="shortcut icon" href="http://blog.rfox.eu/favicon.ico"><!-- Global site tag (gtag.js) - Google Analytics -->

  <script src="https://www.googletagmanager.com/gtag/js?id=UA-142545439-1">
  </script>
  <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
    
      gtag('config', 'UA-142545439-1');
  </script>
  <style>
  .hll { background-color: #ffffcc }
  .c { color: #408080; font-style: italic } /* Comment */
  .err { border: 1px solid #FF0000 } /* Error */
  .k { color: #008000; font-weight: bold } /* Keyword */
  .o { color: #666666 } /* Operator */
  .ch { color: #408080; font-style: italic } /* Comment.Hashbang */
  .cm { color: #408080; font-style: italic } /* Comment.Multiline */
  .cp { color: #BC7A00 } /* Comment.Preproc */
  .cpf { color: #408080; font-style: italic } /* Comment.PreprocFile */
  .c1 { color: #408080; font-style: italic } /* Comment.Single */
  .cs { color: #408080; font-style: italic } /* Comment.Special */
  .gd { color: #A00000 } /* Generic.Deleted */
  .ge { font-style: italic } /* Generic.Emph */
  .gr { color: #FF0000 } /* Generic.Error */
  .gh { color: #000080; font-weight: bold } /* Generic.Heading */
  .gi { color: #00A000 } /* Generic.Inserted */
  .go { color: #888888 } /* Generic.Output */
  .gp { color: #000080; font-weight: bold } /* Generic.Prompt */
  .gs { font-weight: bold } /* Generic.Strong */
  .gu { color: #800080; font-weight: bold } /* Generic.Subheading */
  .gt { color: #0044DD } /* Generic.Traceback */
  .kc { color: #008000; font-weight: bold } /* Keyword.Constant */
  .kd { color: #008000; font-weight: bold } /* Keyword.Declaration */
  .kn { color: #008000; font-weight: bold } /* Keyword.Namespace */
  .kp { color: #008000 } /* Keyword.Pseudo */
  .kr { color: #008000; font-weight: bold } /* Keyword.Reserved */
  .kt { color: #B00040 } /* Keyword.Type */
  .m { color: #666666 } /* Literal.Number */
  .s { color: #BA2121 } /* Literal.String */
  .na { color: #7D9029 } /* Name.Attribute */
  .nb { color: #008000 } /* Name.Builtin */
  .nc { color: #0000FF; font-weight: bold } /* Name.Class */
  .no { color: #880000 } /* Name.Constant */
  .nd { color: #AA22FF } /* Name.Decorator */
  .ni { color: #999999; font-weight: bold } /* Name.Entity */
  .ne { color: #D2413A; font-weight: bold } /* Name.Exception */
  .nf { color: #0000FF } /* Name.Function */
  .nl { color: #A0A000 } /* Name.Label */
  .nn { color: #0000FF; font-weight: bold } /* Name.Namespace */
  .nt { color: #008000; font-weight: bold } /* Name.Tag */
  .nv { color: #19177C } /* Name.Variable */
  .ow { color: #AA22FF; font-weight: bold } /* Operator.Word */
  .w { color: #bbbbbb } /* Text.Whitespace */
  .mb { color: #666666 } /* Literal.Number.Bin */
  .mf { color: #666666 } /* Literal.Number.Float */
  .mh { color: #666666 } /* Literal.Number.Hex */
  .mi { color: #666666 } /* Literal.Number.Integer */
  .mo { color: #666666 } /* Literal.Number.Oct */
  .sa { color: #BA2121 } /* Literal.String.Affix */
  .sb { color: #BA2121 } /* Literal.String.Backtick */
  .sc { color: #BA2121 } /* Literal.String.Char */
  .dl { color: #BA2121 } /* Literal.String.Delimiter */
  .sd { color: #BA2121; font-style: italic } /* Literal.String.Doc */
  .s2 { color: #BA2121 } /* Literal.String.Double */
  .se { color: #BB6622; font-weight: bold } /* Literal.String.Escape */
  .sh { color: #BA2121 } /* Literal.String.Heredoc */
  .si { color: #BB6688; font-weight: bold } /* Literal.String.Interpol */
  .sx { color: #008000 } /* Literal.String.Other */
  .sr { color: #BB6688 } /* Literal.String.Regex */
  .s1 { color: #BA2121 } /* Literal.String.Single */
  .ss { color: #19177C } /* Literal.String.Symbol */
  .bp { color: #008000 } /* Name.Builtin.Pseudo */
  .fm { color: #0000FF } /* Name.Function.Magic */
  .vc { color: #19177C } /* Name.Variable.Class */
  .vg { color: #19177C } /* Name.Variable.Global */
  .vi { color: #19177C } /* Name.Variable.Instance */
  .vm { color: #19177C } /* Name.Variable.Magic */
  .il { color: #666666 } /* Literal.Number.Integer.Long */
  </style>
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:site" content="@Bystroushaak">
  <meta name="twitter:creator" content="@Bystroushaak">
  <meta name="twitter:title" content="Jak se p√≠≈°e programovac√≠ jazyk 3.5: RPython">
  <meta name="twitter:description" content="Parser parsuje, testy proch√°zej√≠ a sv√≠t√≠ zelenƒõ. Co v√≠c si p≈ô√°t. Snad jen .. Ve v≈°emo≈æn√Ωch ƒçl√°nc√≠ch psali, ≈æe je dobr√© prov√°dƒõt ƒçast√© testy, zda jde k√≥d p≈ôelo≈æit RPythonem. Bƒõhem psan√≠ parseru to nemƒõlo smysl, proto≈æe parser je obt√≠≈ænƒõ dƒõliteln√Ω kus a moje soust≈ôedƒõn√≠ m√≠≈ôilo smƒõrem k projit√≠ unittesty. ≈òe≈°it u toho je≈°tƒõ datov√© typy a v≈°echna omezen√≠ RPythonu mi p≈ôi≈°lo jako zbyteƒçn√Ω masochismus, kter√Ω by mohl zp≈Øsobit, ≈æe projekt nikdy nedodƒõl√°m.">
  <meta name="twitter:image" content="http://blog.rfox.eu/cz/Jak_se_pise_programovaci_jazyk/Jak_se_pise_programovaci_jazyk_35_RPython/passing_tests.png">
  <script src="../../scripts.js">
  </script>
</head>
<body onload="on_body_load();">
  <div id="sidebar_top">
    <div id="last_five_top">
      <h3>New posts:</h3>
      <ul>
        <li>
          <a href="../../en/Improvements/The_Most_Personal_Device_experiment/Pebble_smartwatches.html">Pebble smartwatches</a>
        </li>
        <li>
          <a href="../../en/Improvements/The_Most_Personal_Device_experiment.html"><span class="icon">üìÇ</span>The Most Personal Device experiment</a>
        </li>
        <li>
          <a href="../../en/About_this_blog/Unicode_font_subset.html">Unicode font subset</a>
        </li>
        <li>
          <a href="../../en/Weekly_updates/Lifelog_2020-05-25_Work_in_progress_everywhere.html">Lifelog 2020-05-25; Work in progress everywhere</a>
        </li>
        <li>
          <a href="http://blog.rfox.eu/en/Improvements/Vitamins_nootropics_and_other_boosters.html">Vitamins, nootropics and other boosters</a>
        </li>
      </ul>& <a href="../../Changelog.html">more</a>
    </div>
    <div id="links_from_other_pages">
      <h3>Links to this page:</h3>
      <ul>
        <li>
          <a href="Jak_se_pise_programovaci_jazyk_6_Kompilator_AST_do_bytecode.html">Jak se p√≠≈°e programovac√≠ jazyk 6: Kompil√°tor AST do bytecode</a>
        </li>
      </ul>
    </div>
  </div><a class="breadcrumb" href="../../index.html">Bystroushaak's blog</a> / <a class="breadcrumb" href="../index.html">Czech section</a> / <a class="breadcrumb" href="index.html">Jak se p√≠≈°e programovac√≠ jazyk</a> / Jak se p√≠≈°e programovac√≠ jazyk 3.5: RPython
  <article id="de209ad1-cc28-4569-bfbe-bbb8d40f277d" class="page sans">
    <header>
      <h1 class="page-title">Jak se p√≠≈°e programovac√≠ jazyk 3.5: RPython</h1>
    </header>
    <div class="page-body">
      <p id="ebfbab9d-0997-4d7e-9d2a-eff3a907de26" class=""><time>@2019/02/24</time></p>
      <p id="03fb45e0-8bc8-4110-8606-ae91131be017" class="">Parser parsuje, testy proch√°zej√≠ a sv√≠t√≠ zelenƒõ. Co v√≠c si p≈ô√°t. Snad jen .. Ve v≈°emo≈æn√Ωch ƒçl√°nc√≠ch psali, ≈æe je dobr√© prov√°dƒõt ƒçast√© testy, zda jde k√≥d p≈ôelo≈æit RPythonem. Bƒõhem psan√≠ parseru to nemƒõlo smysl, proto≈æe parser je obt√≠≈ænƒõ dƒõliteln√Ω kus a moje soust≈ôedƒõn√≠ m√≠≈ôilo smƒõrem k projit√≠ unittesty. ≈òe≈°it u toho je≈°tƒõ datov√© typy a v≈°echna omezen√≠ RPythonu mi p≈ôi≈°lo jako zbyteƒçn√Ω masochismus, kter√Ω by mohl zp≈Øsobit, ≈æe projekt nikdy nedodƒõl√°m.</p>
      <p id="e64c2589-7e2f-439f-9776-6cd5c77c28f5" class="">Norm√°ln√≠ unittesty pou≈°t√≠m scriptem <code>run_tests.sh</code>, kter√Ω obsahuje n√°sleduj√≠c√≠ k√≥d:</p>
      <pre class="code"><code><span class="ch">#! /usr/bin/env bash</span>
<span class="n">export</span> <span class="n">PYTHONPATH</span><span class="o">=</span><span class="s2">"src/:$PYTHONPATH"</span>
<span class="n">python2</span> <span class="o">-</span><span class="n">m</span> <span class="n">py</span><span class="o">.</span><span class="n">test</span> <span class="n">tests</span> <span class="err">$</span><span class="o">@</span>
</code></pre>
      <p id="7ae683d2-cbb0-4621-9f02-1d9b3b3e663c" class="">Ten je n√°slednƒõ pou≈°tƒõn scriptem <a href="https://github.com/joh/when-changed">when-changed</a>, jen≈æ detekuje zmƒõny na disku a p≈ôi ka≈æd√© √∫pravƒõ zdrojov√Ωch k√≥d≈Ø pust√≠ testy:</p>
      <pre class="code"><code><span class="n">when</span><span class="o">-</span><span class="n">changed</span> <span class="o">-</span><span class="n">s</span> <span class="o">-</span><span class="n">r</span> <span class="n">src</span><span class="o">/</span><span class="n">tinySelf</span><span class="o">/*.</span><span class="n">py</span> <span class="o">-</span><span class="n">r</span> <span class="n">tests</span><span class="o">/*.</span><span class="n">py</span> <span class="o">-</span><span class="n">c</span> <span class="o">./</span><span class="n">run_tests</span><span class="o">.</span><span class="n">sh</span> <span class="o">-</span><span class="n">s</span>
</code></pre>
      <p id="72928d2c-689a-440a-a5f4-e510cdd48e21" class="">Parametr <code>-s</code> zachycuje stdout z test≈Ø.</p>
      <figure id="81a6a1bb-d9c1-4dfb-8716-842f38073d43" class="image">
        <a href="Jak_se_pise_programovaci_jazyk_35_RPython/passing_tests.png"><img style="width:600px" src="Jak_se_pise_programovaci_jazyk_35_RPython/passing_tests.png"></a>
      </figure>
      <h2 id="f8a46fe1-393f-4df1-8a39-5f828968ec6b" class="">RPython testy</h2>
      <p id="e4902ad1-02a4-437f-897d-524b32399029" class="">RPython takto pou≈°tƒõt nem≈Ø≈æu, nebo≈• se nejedn√° o unittesty, ale sp√≠≈° test kompilace trvaj√≠c√≠ na m√©m dom√°c√≠m poƒç√≠taƒçi klidnƒõ minutu.</p>
      <p id="8ec866bf-d7d3-4396-97c3-7fa490f42da8" class="">Pro RPython jsem si do zaƒç√°tku napsal n√°sleduj√≠c√≠ script√≠k <code>run_rpython_test.sh</code>:</p>
      <pre class="code"><code><span class="ch">#! /usr/bin/env bash</span>
<span class="err">$</span><span class="n">HOME</span><span class="o">/</span><span class="n">Plocha</span><span class="o">/</span><span class="n">tests</span><span class="o">/</span><span class="n">pypy</span><span class="o">/</span><span class="n">rpython</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">rpython</span> <span class="n">src</span><span class="o">/</span><span class="n">tinySelf</span><span class="o">/</span><span class="n">target</span><span class="o">.</span><span class="n">py</span>
</code></pre>
      <h3 id="26f6065c-413a-45b5-b4c6-403839a5d1eb" class="">Pypy</h3>
      <p id="59551d7b-57cf-4390-817f-5d9dd6aa50bf" class="">Jak je mo≈æn√© vidƒõt, ten p≈ôedpokl√°d√°, ≈æe v adres√°≈ôi <code>$HOME/Plocha/tests</code> je naklonovan√Ω repozit√°≈ô projektu <a href="https://bitbucket.org/pypy/pypy">pypy</a>. To je mo≈æn√© udƒõlat nap≈ô√≠klad p≈ô√≠kazem:</p>
      <pre class="code"><code><span class="n">hg</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">bitbucket</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">pypy</span><span class="o">/</span><span class="n">pypy</span>
</code></pre>
      <p id="f4e35067-f77d-42a5-90d1-fac743bc0b73" class="">ve slo≈æce <code>$HOME/Plocha/tests</code>.</p>
      <p id="204967d1-fa29-4f85-b15c-63d8c4394917" class="">Repozit√°≈ô je mo≈æn√© zkompilovat a zajistit si tak nejnovƒõj≈°√≠ verzi pypy. Osobnƒõ to tak ale nedƒõl√°m, proto≈æe to trv√° dlouho, nejnovƒõj≈°√≠ revize repozit√°≈ôe typicky obsahuje bugy a nav√≠c kompilace m√° spoustu z√°vislost√≠. Proto pou≈æ√≠v√°m pypy z repozit√°≈ôe (<code>sudo apt install pypy</code>) a vyu≈æ√≠v√°m jen nejnovƒõj≈°√≠ <em>RPython toolkit</em>, kter√Ω je s pypy distribuovan√Ω.</p>
      <p id="fb56c6c8-92d4-48aa-852c-8220432702c8" class="">Jakmile m√°m pypy nainstalovan√©, st√°hnu si je≈°tƒõ PIP (python package manager) pro pypy (standardn√≠ funguje jen pro cpython):</p>
      <pre id="5de25e4b-568a-499e-8abf-ff75bc9a1336" class="code"><code>curl https://bootstrap.pypa.io/get-pip.py | sudo pypy</code></pre>
      <p id="8308f799-72b3-44eb-a6dd-6f151ed89215" class="">Pot√© do pypy doinstaluji nejnovƒõj≈°√≠ verzi parsovac√≠ho bal√≠ku <a href="https://github.com/alex/rply">rply</a>:</p>
      <pre class="code"><code><span class="n">pypy</span> <span class="o">-</span><span class="n">m</span> <span class="n">pip</span> <span class="n">install</span> <span class="o">--</span><span class="n">user</span> <span class="n">rply</span>
</code></pre>
      <p id="935d4a2c-4387-44f2-a2f5-4f19f5539da0" class="">V repozit√°≈ôi debian based syst√©m≈Ø se nach√°z√≠ bal√≠k pypy-rply, kter√Ω ale nedoporuƒçuji pou≈æ√≠vat, proto≈æe m≈Ø≈æe b√Ωt zastaral√Ω v≈Øƒçi PIPu (v dobƒõ psan√≠ ƒçl√°nku je v debian repozit√°≈ôi verze 0.7.4-3 a v pipu 0.7.5).</p>
      <h1 id="6f10e555-8c51-40cd-a90a-07bd77dff1d9" class="">target.py</h1>
      <p id="11a1eba8-07b3-467d-848d-f27ee95c4728" class="">Pou≈°tƒõn√Ω script <a href="http://target.py"><code>target.py</code></a> definuje vstupn√≠ kompilaƒçn√≠ bod. V nƒõm mus√≠ b√Ωt minim√°lnƒõ dvƒõ funkce - <code>target()</code> a pot√© funkce kter√° slou≈æ√≠ jako vstupn√≠ bod spu≈°tƒõn√©ho programu. V podstatƒõ se jedn√° o takov√© <code>meta-main()</code> zn√°m√© z C jazyk≈Ø, tedy funkci urƒçuj√≠c√≠ funkci main. M√°m pocit, ≈æe na linuxu se k tomu pod libc <a href="https://stackoverflow.com/questions/15919356/c-program-start">bƒõ≈ænƒõ pou≈æ√≠v√°</a> __start.</p>
      <p id="e6826aaf-91c6-47fa-8c4c-2cdb8aeac878" class="">Obsah funkce <code>target()</code> se spou≈°t√≠ v dobƒõ p≈ôekladu a proto je mo≈æn√© v nƒõm prov√°dƒõt r≈Øzn√© meta-programov√°n√≠, nap≈ô√≠klad volat funkce, kter√© vygeneruj√≠ funkce, kter√© jsou pot√© zkompilov√°ny.</p>
      <p id="3fd1c62b-d739-487d-b1e4-e4e73070b668" class="">Osobnƒõ jsem do zaƒç√°tku pou≈æil jen nejjednodu≈°≈°√≠ target.py:</p>
      <pre class="code"><code><span class="ch">#! /usr/bin/env python2</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">from</span> <span class="nn">rpython.jit.codewriter.policy</span> <span class="kn">import</span> <span class="n">JitPolicy</span>
<span class="kn">from</span> <span class="nn">parser</span> <span class="kn">import</span> <span class="n">lex_and_parse</span>


<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">argv</span><span class="p">):</span>
    <span class="nb">print</span> <span class="n">lex_and_parse</span><span class="p">(</span><span class="s2">"1"</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">target</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">main</span><span class="p">,</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">jitpolicy</span><span class="p">(</span><span class="n">driver</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">JitPolicy</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">untranslated_main</span><span class="p">():</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">main</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">'__main__'</span><span class="p">:</span>
    <span class="n">untranslated_main</span><span class="p">()</span>
</code></pre>
      <p id="f069e582-5bd6-4ecc-8ba0-ae65db0b7773" class="">Jak je vidƒõt, jen se pust√≠ funkce <code>lex_and_parse("1")</code>, tedy pokus o zparsov√°n√≠ zdrojov√©ho k√≥du obsahuj√≠c√≠ho jen ƒç√≠slo jedna.</p>
      <p id="d5153cb7-9a19-47c0-8f98-8982ac6d1540" class="">Pokud by v√°s zaj√≠mal princip fungov√°n√≠ p≈ôekladu na C k√≥d, tak znovu doporuƒçuji n√°sleduj√≠c√≠ odkazy:</p>
      <ul id="c7a4d905-0444-454c-ba72-0d4679b442fe" class="bulleted-list">
        <li>
          <a href="https://www.root.cz/clanky/rpython-prekvapive-vykonny-dialekt-pythonu-na-nemz-je-zalozen-pypy/">RPython: p≈ôekvapivƒõ v√Ωkonn√Ω dialekt Pythonu, na nƒõm≈æ je zalo≈æen PyPy</a>
        </li>
      </ul>
      <ul id="3de93987-2796-45c4-87c1-7a02b69a0ea4" class="bulleted-list">
        <li>
          <a href="https://rpython.readthedocs.io/en/latest/translation.html">The RPython Toolchain</a>
        </li>
      </ul>
      <p id="6861fdd3-e634-418d-ab69-123838d3bb26" class="">Hezky to cel√© shrnuje n√°sleduj√≠c√≠ graf:</p>
      <figure id="b47eeec8-6d29-4e48-a7c7-f804da5eaf1f" class="image">
        <a href="https://rpython.readthedocs.io/en/latest/_images/translation-detail-0.9.png"><img src="https://rpython.readthedocs.io/en/latest/_images/translation-detail-0.9.png"></a>
      </figure>
      <p id="4a636dd7-6d3b-46b7-b530-526a3d3920e2" class="">Ve zkratce je vytvo≈ôen <em>flow graf</em> k√≥du, kter√Ω je pot√© projit analyz√°torem datov√Ωch typ≈Ø, jen≈æ se sna≈æ√≠ jednotliv√Ωm element≈Øm p≈ôi≈ôadit statick√© datov√© typy. Pokud se poda≈ô√≠, jsou aplikov√°ny optimizace, p≈ô√≠padnƒõ p≈ôid√°n JIT, vyplivnut C k√≥d a cel√© je to zkompilov√°no pomoc√≠ norm√°ln√≠ho C kompil√°toru.</p>
      <p id="bb7c31b9-73d6-4928-87be-86d01692d77a" class="">To ≈æe jde o <em>flow graf</em> ov≈°em znamen√°, ≈æe ƒç√°sti k√≥du, kter√© nejsou vol√°ny nejsou p≈ôekl√°d√°ny. Cel√© je mo≈æn√© si to p≈ôedstavit jako kompilaci AST, i kdy≈æ ve skuteƒçnosti se k√≥d prvnƒõ kompiluje do pythonn√≠ho bytecode a teprve ten se pot√© analyzuje a z nƒõj se stav√≠ <a href="https://en.wikipedia.org/wiki/Control_flow_graph">control flow graph</a>.</p>
      <p id="efe35440-7761-463b-92d1-99186d2a906f" class="">Prakticky to znamen√°, ≈æe pokud m√°te v objektu metodu, kterou nejde p≈ôelo≈æit, tak na to nep≈ôijdete, dokud v k√≥du nebude nƒõkde m√≠sto, odkud se vol√°. Do t√© doby v≈Øbec nen√≠ souƒç√°st√≠ <em>flow grafu</em>.</p>
      <h1 id="ea604512-a828-4918-ae67-a6bc8a112954" class="">Prvn√≠ pu≈°tƒõn√≠ test≈Ø</h1>
      <p id="303f23f5-b9c1-4d41-bb15-00b1f80f96ac" class="">Prvn√≠ pu≈°tƒõn√≠ test≈Ø mi samoz≈ôejmƒõ nepro≈°lo:</p>
      <figure id="ef1d019b-bb40-40d7-a67c-39d5ba6e67d5" class="image">
        <a href="Jak_se_pise_programovaci_jazyk_35_RPython/rpython_first_fail.png"><img style="width:810px" src="Jak_se_pise_programovaci_jazyk_35_RPython/rpython_first_fail.png"></a>
      </figure>
      <p id="ee62a545-6863-47eb-8fb3-b13dcac8a3de" class="">≈Ω√°dn√© p≈ôekvapen√≠. Jak jsem psal, RPython pou≈æ√≠v√° silnƒõ omezenou verzi pythonu a m≈Øj k√≥d nijak ne≈°et≈ô√≠ <em>list comprehensionama</em>, <em>closures</em> a dal≈°√≠mi ‚Äûvysoko√∫rov≈àov√Ωmi‚Äú konstrukty.</p>
      <p id="0d03be9d-25b0-4f55-8808-62c3c5e1cc7d" class="">K√≥d je nyn√≠ zapot≈ôeb√≠ <em>‚Äûzhloupit‚Äú</em> a p≈ôidat typov√© hinty, kter√© RPythonu pomohou anotovat <em>flow graph</em> v m√≠stech, kde si je nedok√°≈æe odvodit s√°m.</p>
      <h2 id="ec75f321-da4b-4abf-b46b-1babf9215362" class="">Redukce na RPython</h2>
      <p id="4cec8392-13ac-44e2-80f9-c581ae4cd3de" class="">Nyn√≠ mus√≠m vz√≠t dynamick√Ω a relativnƒõ vysko√∫rov≈àov√Ω python a p≈ôev√©st ho na staticky typovan√Ω k√≥d, kter√Ω by se psal podobnƒõ jako t≈ôeba v Javƒõ. To v≈°e ƒçistƒõ v syntaxi pythonu.</p>
      <p id="ea94e078-c1d1-4357-ae96-fb09574fc9b3" class="">ƒå√°st omezen√≠ je pops√°na v ofici√°ln√≠ dokumentaci:</p>
      <ul id="25287908-382c-491a-9bc4-086c00794a2c" class="bulleted-list">
        <li>
          <a href="http://rpython.readthedocs.io/en/latest/rpython.html">RPython Language</a>
        </li>
      </ul>
      <p id="b2245aa6-2444-4b41-a9c1-770c588f00b3" class="">Mnohem lep≈°√≠ p≈ôedstavu v≈°ak d√°v√° ƒçl√°nek</p>
      <ul id="6dbd927b-3546-4571-8e4d-6e43695a5177" class="bulleted-list">
        <li>
          <a href="https://refi64.com/posts/the-magic-of-rpython.html">The Magic of RPython</a> (<a href="http://web.archive.org/web/20180317140809/https://refi64.com/posts/the-magic-of-rpython.html">webarchive</a>)
        </li>
      </ul>
      <p id="03c8c121-24fe-409e-bf94-e7a01e2e1d91" class="">Mezi v√Ωznamn√° omezen√≠ pat≈ô√≠ nap≈ô√≠klad omezen√≠ promƒõnn√Ωch pouze na jeden datov√Ω typ v dan√©m <em>scope</em>. To znamen√°, ≈æe do nich nem≈Ø≈æete p≈ôi≈ôadit hodnotu s jin√Ωm datov√Ωm typem, jakmile je jednou pou≈æijete. Seznamy mus√≠ b√Ωt cel√© tvo≈ôeny z jednoho datov√©ho typu. Closures nefunguj√≠ v≈Øbec. List comprehensions funguj√≠, ale ne √∫plnƒõ tak jak by ƒçlovƒõk ƒçekal. Gener√°tory jsou v√≠ce/m√©nƒõ podporov√°ny, ale nejdou s nimi dƒõlat r≈Øzn√© ps√≠ kusy, jako t≈ôeba kompozice.</p>
      <p id="f76a9371-e624-4188-a449-4dd1a383006c" class="">Otravnƒõ omezuj√≠c√≠ je nutnost v≈°ech funkc√≠ v parseru vracet stejn√Ω datov√Ω typ, resp. t≈ô√≠du odvozenou od stejn√©ho datov√©ho typu. <code>rply</code> k tomu nab√≠z√≠ <a href="https://github.com/alex/rply/blob/master/rply/token.py#L1">rply.token.BaseBox</a>, od kter√© mus√≠ b√Ωt podƒõdƒõny v≈°echny AST prvky. Nav√≠c je v≈°ak ale t≈ôeba p≈ôepsat i v≈°echny parsovac√≠ funkce tak, aby nevracely <code>list</code>, <code>dict</code>, nebo jin√© nativn√≠ typy, ale datov√Ω typ odvozen√Ω od <code>BaseBox</code>u.</p>
      <p id="5a0ffda4-eb3a-4d68-a480-2d5ca8543316" class="">Proto jsem byl nucen nadefinovat t≈ô√≠dy <code>StrContainer</code>, <code>DictContainer</code>, <code>ListContainer</code> a <code>KwSlotContainer</code>, a pou≈æ√≠vat je na m√≠stech, kde jsem d≈ô√≠ve pou≈æ√≠val prostƒõ jen <code>dict</code>, nebo <code>list</code>. P≈Øvodnƒõ jsem chtƒõl pou≈æ√≠t jen Container, kter√Ω by udr≈æoval obecn√Ω datov√Ω typ, ale uk√°zalo se, ≈æe na nƒõj taky plat√≠ omezen√≠ a pro jednu instanci je mo≈æn√© pou≈æ√≠t jen jeden datov√Ω typ. Do t≈ô√≠dy ve stylu:</p>
      <pre class="code"><code><span class="k">class</span> <span class="nc">Container</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>
</code></pre>
      <p id="ce7de1d9-5e6b-4feb-bef9-9675de086509" class="">nen√≠ mo≈æn√© v r≈Øzn√Ωch instanc√≠ch ulo≈æit r≈Øzn√© datov√© typy. To je pro mƒõ jako≈æto dlouhodob√©ho program√°tora v pythonu docela nezvyk.</p>
      <p id="6593d087-a9fc-4a71-aa6e-e881002758ab" class="">Hezky je to vidƒõt nap≈ô√≠klad na parsovac√≠ funkci <code>kw_slot_definition()</code>, kter√° se promƒõnila z</p>
      <pre class="code"><code><span class="nd">@pg</span><span class="o">.</span><span class="n">production</span><span class="p">(</span><span class="s1">'slot_definition : kw_slot_name ASSIGNMENT expression'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">kw_slot_definition</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">Object</span><span class="p">),</span> <span class="s2">"Only objects are assignable to kw slots!"</span>

    <span class="n">slot_name</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">obj</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">obj</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">slot_name</span><span class="p">:</span> <span class="n">obj</span><span class="p">}</span>
</code></pre>
      <p id="8eb34dc5-8861-439d-a3c7-9d69c2554459" class="">na</p>
      <pre class="code"><code><span class="nd">@pg</span><span class="o">.</span><span class="n">production</span><span class="p">(</span><span class="s1">'slot_definition : kw_slot_name ASSIGNMENT expression'</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">kw_slot_definition</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="n">slot_info</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">obj</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">slot_info</span><span class="p">,</span> <span class="n">KwSlotContainer</span><span class="p">)</span>
    <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Object</span><span class="p">)</span>

    <span class="n">obj</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">slot_info</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">DictContainer</span><span class="p">({</span><span class="n">slot_info</span><span class="o">.</span><span class="n">slot_name</span><span class="p">:</span> <span class="n">obj</span><span class="p">})</span>
</code></pre>
      <p id="e6dc9ff0-a859-4905-9d25-ccbb77562d79" class="">Za pov≈°imnut√≠ stoj√≠ tak√© nƒõkolik pou≈æit√≠ <code>assert isinstance(..)</code>. V prvn√≠m p≈ô√≠padƒõ pou≈æ√≠v√°m <code>assert</code> tak, jak byl zam√Ω≈°len, tedy k uji≈°tƒõn√≠ se, ≈æe do funkce nepoleze datov√Ω typ jin√Ω ne≈æ objekt a pokud ano, tak vyhod√≠m chybovou hl√°≈°ku.</p>
      <p id="6d9a221e-2a05-419e-ad6d-c135a2513e9b" class="">Ve druh√©m p≈ô√≠padƒõ <code>assert</code> nefunguje jako p≈ô√≠kaz pro uji≈°tƒõn√≠, ale jako <em>type hint</em> (<em>typov√° n√°povƒõda</em>) pro RPython, kter√Ω mu ≈ô√≠k√°, jak√©ho datov√©ho typu jsou dan√© parametry. Pokud bych ho neuvedl, do≈°lo by v dobƒõ p≈ôekladu k vyhozen√≠ v√Ωjimky, kter√° m≈Ø≈æe vypadat nap≈ô√≠klad takto:</p>
      <pre class="code"><code><span class="p">[</span><span class="n">translation</span><span class="p">:</span><span class="n">ERROR</span><span class="p">]</span> <span class="n">NoSuchAttrError</span><span class="p">:</span> 

<span class="n">the</span> <span class="n">attribute</span> <span class="s1">'params'</span> <span class="n">goes</span> <span class="n">here</span> <span class="n">to</span> <span class="o">&lt;</span><span class="n">ClassDef</span> <span class="s1">'rply.token.BaseBox'</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">but</span> <span class="n">it</span> <span class="ow">is</span> <span class="n">forbidden</span> <span class="n">here</span>


    <span class="n">v0</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj_0</span><span class="p">,</span> <span class="p">(</span><span class="s1">'params'</span><span class="p">))</span>

<span class="n">In</span> <span class="o">&lt;</span><span class="n">FunctionGraph</span> <span class="n">of</span> <span class="p">(</span><span class="n">parser</span><span class="p">:</span><span class="mi">453</span><span class="p">)</span><span class="n">kw_slot_definition</span> <span class="n">at</span> <span class="mh">0x55b7e3841cc8</span><span class="o">&gt;</span><span class="p">:</span>
<span class="n">Happened</span> <span class="n">at</span> <span class="n">file</span> <span class="n">src</span><span class="o">/</span><span class="n">tinySelf</span><span class="o">/</span><span class="n">parser</span><span class="o">.</span><span class="n">py</span> <span class="n">line</span> <span class="mi">461</span>

        <span class="n">slot_info</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    
        <span class="c1"># assert isinstance(slot_info, KwSlotContainer)</span>
        <span class="c1"># assert isinstance(obj, Object)</span>
    
<span class="o">==&gt;</span>     <span class="n">obj</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">slot_info</span><span class="o">.</span><span class="n">parameters</span><span class="p">)</span>
    
        <span class="k">return</span> <span class="n">DictContainer</span><span class="p">({</span><span class="n">slot_info</span><span class="o">.</span><span class="n">slot_name</span><span class="p">:</span> <span class="n">obj</span><span class="p">})</span>
</code></pre>
      <p id="49c65f87-61bb-4fc0-899a-07138ffe8af0" class="">Z chyby je jasnƒõ vidƒõt, ≈æe RPython nech√°pe, proƒç se sna≈æ√≠m u nezn√°m√©ho objektu p≈ôistupovat k ƒçlensk√© promƒõnn√© <code>params</code>.</p>
      <p id="d9211181-94ee-458c-8da2-2a3dc4e55809" class="">Na konci funkce pak vrac√≠m <code>DictContainer</code> ƒçistƒõ jen proto, ≈æe vr√°cen√© parsovan√© hodnoty mus√≠ b√Ωt v≈°echny stejn√Ωm datov√Ωm typem, nebo jeho potomky. To je zp≈Øsobeno vnit≈ôn√≠m fungov√°n√≠m parseru, kter√Ω jednotliv√© odekorovan√© funkce zpracov√°v√° v r≈Øzn√Ωch kolekc√≠ch, ve kter√Ωch nem≈Ø≈æou b√Ωt pod RPythonem r≈Øzn√© datov√© typy.</p>
      <p id="7238ea02-8f98-405a-a238-bd39742dde4b" class="">Zaj√≠mav√© jsou chyby <code>Blocked block -- operation cannot succeed</code>, kter√© mi jeden veƒçer docela zamotaly hlavu. Nakonec jsem v≈°ak prohled√°n√≠m konference zjistil, ≈æe se jedn√° o chybu kdy≈æ RPython type annotator prvnƒõ vleze do metody objektu a je≈°tƒõ nepro≈°el <code>.__init__()</code> metodu. Pokud je v metodƒõ p≈ôistoupeno k ƒçlensk√Ωm promƒõnn√Ωm, tak dojde chybƒõ, jeliko≈æ anot√°tor nev√≠ o tom ≈æe byly definov√°ny. ≈òe≈°en√≠ je docela prost√©, staƒç√≠ objekt prostƒõ p≈ôedt√≠m nƒõkde pou≈æ√≠t, aby byla o-anotov√°na <code>.__init__()</code> metoda.</p>
      <h2 id="9a496d5f-10b9-4da6-8548-ab9f084c167c" class="">P≈ôeklad</h2>
      <p id="2fae3c5e-830a-43f3-b387-52b44fec2f00" class="">V√Ω≈°e uveden√© pot√≠≈æe jsou jen mal√° ƒç√°st toho, s ƒç√≠m se ƒçlovƒõk setk√°. Osobnƒõ jsem postupoval tak, ≈æe jsem cel√Ω parser a≈æ na prvn√≠ pravidlo a posledn√≠ parsovac√≠ funkci <code>parse_and_lex()</code> zakomentoval a postupnƒõ p≈ôev√°dƒõl jednotliv√° pravidla. T√≠mhle postupem mi to trvalo pomƒõrnƒõ dlouho, ale nakonec se dostavil v√Ωsledek:</p>
      <figure id="ec340534-cd5a-4762-8984-d8ba71ea1ed5" class="image">
        <a href="Jak_se_pise_programovaci_jazyk_35_RPython/compilation.gif"><img style="width:896px" src="Jak_se_pise_programovaci_jazyk_35_RPython/compilation.gif"></a>
      </figure>
      <p id="6b05db44-5d5b-4a62-98a3-9b29fe5f70cd" class=""><em>(Kompilaƒçn√≠ frakt√°ly v p≈Øvodn√≠ kvalitƒõ:</em> <em><a href="https://youtu.be/A_OhtmUH830">https://youtu.be/A_OhtmUH830</a></em><em>)</em></p>
      <h1 id="ea87c7ac-48fb-4ba0-af65-7c044bf42bb0" class="">Pokraƒçov√°n√≠</h1>
      <p id="090d3364-ee9f-48d2-a3bf-497ee5bf0195" class="">P≈ô√≠≈°tƒõ se pod√≠v√°me na n√°vrh rozlo≈æen√≠ a reprezentace objekt≈Ø v pamƒõti p≈ôed t√≠m, ne≈æ p≈ôijde na ≈ôadu psan√≠ virtu√°ln√≠ho stroje a kompil√°toru do bytecode.</p>
      <h1 id="b1e1c147-14bb-4424-82bb-bdf222a7c238" class="">Relevantn√≠ diskuze</h1>
      <ul id="46b4620c-c297-4e75-926b-094e212b43ab" class="bulleted-list">
        <li>
          <a href="http://www.abclinuxu.cz/blog/bystroushaak/2019/2/jak-se-pise-programovaci-jazyk-3.5-rpython">Jak se p√≠≈°e programovac√≠ jazyk 3.5: RPython</a> (abclinuxu)
        </li>
      </ul>
      <p id="8b29ea42-1b6a-4753-90cc-41593cf8831a" class=""></p>
    </div>
  </article>
  <div class="corner-ribbon top-right red">
    <a href="https://www.patreon.com/bePatron?u=2618881">Become a Patron</a>
  </div><a class="twitter-share-button" id="twitter_button" href="#"><img src="../../tweet_button.svg"></a>
  <div id="sidebar_bottom">
    <div id="last_five_bottom">
      <h3>New posts:</h3>
      <ul>
        <li>
          <a href="../../en/Improvements/The_Most_Personal_Device_experiment/Pebble_smartwatches.html">Pebble smartwatches</a>
        </li>
        <li>
          <a href="../../en/Improvements/The_Most_Personal_Device_experiment.html"><span class="icon">üìÇ</span>The Most Personal Device experiment</a>
        </li>
        <li>
          <a href="../../en/About_this_blog/Unicode_font_subset.html">Unicode font subset</a>
        </li>
        <li>
          <a href="../../en/Weekly_updates/Lifelog_2020-05-25_Work_in_progress_everywhere.html">Lifelog 2020-05-25; Work in progress everywhere</a>
        </li>
        <li>
          <a href="http://blog.rfox.eu/en/Improvements/Vitamins_nootropics_and_other_boosters.html">Vitamins, nootropics and other boosters</a>
        </li>
      </ul>& <a href="../../Changelog.html">more</a>
    </div>
    <div id="links_from_other_pages">
      <h3>Links to this page:</h3>
      <ul>
        <li>
          <a href="Jak_se_pise_programovaci_jazyk_6_Kompilator_AST_do_bytecode.html">Jak se p√≠≈°e programovac√≠ jazyk 6: Kompil√°tor AST do bytecode</a>
        </li>
      </ul>
    </div>
  </div>
</body>
</html>
